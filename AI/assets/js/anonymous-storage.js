if(typeof AccessControl==='undefined'){class AccessControl{constructor(){this.isLoggedIn=false;this.anonymousCount=this.loadAnonymousCount();this.anonymousLimit=5;this.isApiDomain=false;this.isPublicDomain=false;this.user=null;}
loadAnonymousCount(){try{const today=new Date().toDateString();const stored=localStorage.getItem('anonymous_count');if(stored){const data=JSON.parse(stored);if(data.date===today){console.log(`ğŸ“Š åŠ è½½ä»Šæ—¥åŒ¿åæ¶ˆæ¯è®¡æ•°: ${data.count}`);return data.count||0;}}
console.log('ğŸ“Š æ–°çš„ä¸€å¤©ï¼Œé‡ç½®åŒ¿åæ¶ˆæ¯è®¡æ•°');this.saveAnonymousCount(0);return 0;}catch(error){console.error('åŠ è½½åŒ¿åè®¡æ•°å¤±è´¥:',error);return 0;}}
saveAnonymousCount(count){try{const today=new Date().toDateString();localStorage.setItem('anonymous_count',JSON.stringify({date:today,count:count}));console.log(`ğŸ’¾ ä¿å­˜åŒ¿åæ¶ˆæ¯è®¡æ•°: ${count}`);}catch(error){console.error('ä¿å­˜åŒ¿åè®¡æ•°å¤±è´¥:',error);}}
async checkAccess(){try{const response=await fetch('/api/auth/check-access');const data=await response.json();if(data.success){this.isLoggedIn=data.isLoggedIn;this.anonymousCount=data.count||0;this.anonymousLimit=data.limit||5;this.isApiDomain=data.isApiDomain||false;this.isPublicDomain=data.isPublicDomain||false;this.user=data.user;if(this.isApiDomain&&!this.isLoggedIn){return{allowed:false,requireLogin:true,message:'æ­¤APIæ¥å£éœ€è¦ç™»å½•æ‰èƒ½ä½¿ç”¨'};}
return{allowed:data.allowed,requireLogin:data.requireLogin||false,message:data.message||''};}
return{allowed:true,requireLogin:false,message:''};}catch(error){console.error('æ£€æŸ¥è®¿é—®æƒé™å¤±è´¥:',error);return{allowed:true,requireLogin:false,message:''};}}
showAnonymousStatus(){if(this.isLoggedIn){return '';}
const remaining=this.anonymousLimit-this.anonymousCount;if(remaining<=0){return 'å·²è¾¾åˆ°å…è´¹é™åˆ¶ï¼Œè¯·ç™»å½•ç»§ç»­ä½¿ç”¨';}
return `å‰©ä½™ ${remaining}/${this.anonymousLimit} æ¡å…è´¹æ¶ˆæ¯`;}
canSendMessage(){if(this.isLoggedIn){return{allowed:true,message:''};}
if(this.isApiDomain){return{allowed:false,requireLogin:true,message:'æ­¤APIæ¥å£éœ€è¦ç™»å½•æ‰èƒ½ä½¿ç”¨'};}
if(this.anonymousCount>=this.anonymousLimit){return{allowed:false,requireLogin:true,message:`æ‚¨å·²è¾¾åˆ°å…è´¹æ¶ˆæ¯é™åˆ¶ï¼ˆ${this.anonymousLimit}æ¡ï¼‰ï¼Œè¯·ç™»å½•ä»¥ç»§ç»­ä½¿ç”¨`};}
return{allowed:true,message:''};}
canUsePro(){if(!this.isLoggedIn){return{allowed:false,requireLogin:true,message:'éœ€è¦ç™»å½•æ‰èƒ½ä½¿ç”¨Proæ¨¡å‹'};}
if(!this.user||!this.user.can_use_pro){return{allowed:false,requireLogin:false,message:'æ‚¨æ²¡æœ‰Proè®¿é—®æƒé™'};}
return{allowed:true,message:''};}
updateCount(count){this.anonymousCount=count;if(!this.isLoggedIn){this.saveAnonymousCount(count);}}
incrementCount(){this.anonymousCount++;if(!this.isLoggedIn){this.saveAnonymousCount(this.anonymousCount);}
console.log(`ğŸ“ˆ åŒ¿åæ¶ˆæ¯è®¡æ•°å¢åŠ : ${this.anonymousCount}/${this.anonymousLimit}`);}
decrementCount(){if(this.anonymousCount>0){this.anonymousCount--;if(!this.isLoggedIn){this.saveAnonymousCount(this.anonymousCount);}
console.log(`ğŸ“‰ åŒ¿åæ¶ˆæ¯è®¡æ•°å›æ»š: ${this.anonymousCount}/${this.anonymousLimit}`);}}
showLoginPrompt(message){if(confirm(message+'\n\næ˜¯å¦ç°åœ¨ç™»å½•ï¼Ÿ')){this.showLoginPage();}}
showLoginPage(){window.location.reload();}}
if(typeof window!=='undefined'&&typeof window.AccessControl==='undefined'){window.AccessControl=AccessControl;}}
const anonymousStorage={STORAGE_KEY:'wawa_anonymous_sessions',MAX_SESSIONS:10,getSessions(){try{const data=localStorage.getItem(this.STORAGE_KEY);if(data){const sessions=JSON.parse(data);return sessions.sort((a,b)=>new Date(b.updated_at||b.created_at)-new Date(a.updated_at||a.created_at));}}catch(e){console.error('è¯»å–ä¼šè¯å¤±è´¥:',e);}
return[];},saveSessions(sessions){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(sessions));}catch(e){console.error('ä¿å­˜ä¼šè¯å¤±è´¥:',e);this.cleanupOldSessions();}},createSession(title='æ–°å¯¹è¯'){const sessions=this.getSessions();const now=new Date().toISOString();const session={id:'anon_'+Date.now()+'_'+Math.random().toString(36).substr(2,9),title:title,icon_type:'chat',created_at:now,updated_at:now,messages:[]};sessions.unshift(session);while(sessions.length>this.MAX_SESSIONS){sessions.pop();}
this.saveSessions(sessions);return session;},getSession(sessionId){const sessions=this.getSessions();return sessions.find(s=>s.id===sessionId)||null;},getMessages(sessionId){const session=this.getSession(sessionId);return session?(session.messages||[]):[];},addMessage(sessionId,message){const sessions=this.getSessions();const session=sessions.find(s=>s.id===sessionId);if(session){if(!session.messages){session.messages=[];}
message.id=message.id||Date.now();message.created_at=message.created_at||new Date().toISOString();session.messages.push(message);session.updated_at=new Date().toISOString();this.saveSessions(sessions);}},updateSessionMeta(sessionId,title,iconType){const sessions=this.getSessions();const session=sessions.find(s=>s.id===sessionId);if(session){if(title)session.title=title;if(iconType)session.icon_type=iconType;session.updated_at=new Date().toISOString();this.saveSessions(sessions);}},updateSession(sessionId,data){const sessions=this.getSessions();const session=sessions.find(s=>s.id===sessionId);if(session){Object.assign(session,data);session.updated_at=new Date().toISOString();this.saveSessions(sessions);}},deleteSession(sessionId){const sessions=this.getSessions();const index=sessions.findIndex(s=>s.id===sessionId);if(index!==-1){sessions.splice(index,1);this.saveSessions(sessions);return true;}
return false;},cleanupOldSessions(){const sessions=this.getSessions();while(sessions.length>this.MAX_SESSIONS/2){sessions.pop();}
this.saveSessions(sessions);},clearAll(){localStorage.removeItem(this.STORAGE_KEY);},getStorageInfo(){const data=localStorage.getItem(this.STORAGE_KEY)||'';const sessions=this.getSessions();return{sessionsCount:sessions.length,totalMessages:sessions.reduce((sum,s)=>sum+(s.messages?.length||0),0),storageSize:new Blob([data]).size};}};if(typeof window!=='undefined'){window.anonymousStorage=anonymousStorage;}