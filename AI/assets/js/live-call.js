class LiveCall{constructor(options={}){this.wsUrl=options.wsUrl||'wss://ailive.wawacm.com';this.tokenEndpoint=options.tokenEndpoint||'/api/live-token.php';this.onStatusChange=options.onStatusChange||(()=>{});this.onMessage=options.onMessage||(()=>{});this.onError=options.onError||(()=>{});this.onAudioLevel=options.onAudioLevel||(()=>{});this.isActive=false;this.isConnecting=false;this.mode='audio-only';this.selectedVoice='Aoede';this.systemPrompt='';this.isMuted=false;this.accessToken=null;this.tokenExpiresAt=0;this.tokenRefreshTimer=null;this.websocket=null;this.shouldReconnect=false;this.reconnectAttempts=0;this.reconnectTimer=null;this.maxReconnectAttempts=5;this.mediaStream=null;this.inputContext=null;this.audioProcessor=null;this.videoTrack=null;this.imageCapture=null;this.videoInterval=null;this.currentFacingMode='user';this.isSwitchingCamera=false;this.videoElement=null;this.playbackContext=null;this.gainNode=null;this.speakerMuted=false;this.audioQueue=[];this.nextPlayTime=0;this.isProcessingAudio=false;this.isAIPlaying=false;this.lastAIStopTime=0;this.currentAudioSources=[];this.audioHistory=[];this.isSpeaking=false;this.lastSpeechTime=0;this.speechStartTime=0;this.INTERRUPT_DELAY=400;this.videoSendingActive=false;this.videoSendInFlight=false;this.SPEECH_THRESHOLD=0.04;this.POST_SPEECH_BUFFER=3000;this.VIDEO_FPS=3;this.VIDEO_TARGET_SIZE=512;this.VIDEO_JPEG_QUALITY=0.80;this.MAX_WS_BUFFER=1024*1024;this.HISTORY_WINDOW=20;this.stats={audioChunks:0,videoFrames:0,messages:0};this.voiceConfigs={'Aoede':{name:'Aoede',label:'女性·温柔'},'Kore':{name:'Kore',label:'女性·专业'},'Puck':{name:'Puck',label:'男性·活泼'},'Charon':{name:'Charon',label:'男性·沉稳'},'Fenrir':{name:'Fenrir',label:'男性·深沉'}};}
checkMediaSupport(){return{supported:true};}
getGetUserMedia(){if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){return(constraints)=>navigator.mediaDevices.getUserMedia(constraints);}
const legacyGetUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;if(legacyGetUserMedia){return(constraints)=>new Promise((resolve,reject)=>{legacyGetUserMedia.call(navigator,constraints,resolve,reject);});}
return null;}
async getToken(forceRefresh=false,captchaData=null){if(!forceRefresh&&!captchaData&&this.accessToken&&this.tokenExpiresAt>Date.now()+300000){return this.accessToken;}
try{const endpoint=forceRefresh?`${this.tokenEndpoint}/refresh-token`:`${this.tokenEndpoint}/get-token`;const headers={'Content-Type':'application/json'};if(this.accessToken){headers['Authorization']=`Bearer ${this.accessToken}`;}
const body=captchaData?JSON.stringify(captchaData):null;const response=await fetch(endpoint,{method:'POST',headers,body,credentials:'include'});const data=await response.json();if(!data.success&&data.error==='captcha_required'){const captchaEvent=new CustomEvent('liveCallCaptchaRequired',{detail:{captcha_id:data.captcha_id}});window.dispatchEvent(captchaEvent);throw new Error('需要验证码验证');}
if(!data.success){throw new Error(data.message||data.error||'获取 Token 失败');}
this.accessToken=data.access_token;this.tokenExpiresAt=Date.now()+(data.expires_in*1000);this.systemPrompt=data.system_prompt||this.systemPrompt;this.scheduleTokenRefresh(data.refresh_before||(data.expires_in-300));return this.accessToken;}catch(error){this.onError('Token 获取失败: '+error.message);throw error;}}
scheduleTokenRefresh(refreshInSeconds){if(this.tokenRefreshTimer){clearTimeout(this.tokenRefreshTimer);}
const refreshTime=Math.max(1,refreshInSeconds-60)*1000;this.tokenRefreshTimer=setTimeout(async()=>{if(this.isActive){try{await this.getToken(true);}catch(error){}}},refreshTime);}
getVoiceList(){return Object.entries(this.voiceConfigs).map(([key,value])=>({value:key,name:value.name,label:value.label}));}
setVoice(voice){if(this.voiceConfigs[voice]){this.selectedVoice=voice;}}
setMode(mode){if(this.isActive){return false;}
this.mode=mode;return true;}
setSystemPrompt(prompt){this.systemPrompt=prompt;}
async start(videoElement=null){if(this.isActive||this.isConnecting){return;}
const mediaCheck=this.checkMediaSupport();if(!mediaCheck.supported){this.onError(mediaCheck.error);this.onStatusChange('error',mediaCheck.error);throw new Error(mediaCheck.error);}
this.isConnecting=true;this.shouldReconnect=true;this.reconnectAttempts=0;this.stats={audioChunks:0,videoFrames:0,messages:0};this.videoElement=videoElement;this.isMuted=false;try{this.onStatusChange('connecting','获取认证...');const token=await this.getToken();this.onStatusChange('connecting','请求媒体权限...');await this.initMedia(videoElement);this.onStatusChange('connecting','连接服务器...');await this.connectWebSocket(token);}catch(error){this.isConnecting=false;this.onStatusChange('error',error.message);this.onError(error.message);throw error;}}
async initMedia(videoElement){const constraints={audio:{sampleRate:16000,channelCount:1,echoCancellation:true,noiseSuppression:true,autoGainControl:true}};if(this.mode==='audio-video'){constraints.video={facingMode:this.currentFacingMode,width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30}};}
const getUserMedia=this.getGetUserMedia();if(!getUserMedia){throw new Error('您的浏览器不支持语音通话。请使用 Chrome、Firefox 或 Safari 的最新版本，并确保使用 HTTPS 访问。');}
try{this.mediaStream=await getUserMedia(constraints);}catch(error){if(error.name==='NotAllowedError'){throw new Error('请允许使用麦克风'+(this.mode==='audio-video'?'和摄像头':''));}else if(error.name==='NotFoundError'){throw new Error('未找到麦克风'+(this.mode==='audio-video'?'或摄像头':''));}else if(error.name==='NotSupportedError'||error.name==='TypeError'){throw new Error('语音通话需要 HTTPS 安全连接。如果您在开发环境，请使用 localhost 访问。');}else{throw new Error('无法访问媒体设备: '+error.message);}}
if(this.mode==='audio-video'&&videoElement){videoElement.srcObject=this.mediaStream;this.videoTrack=this.mediaStream.getVideoTracks()[0];const settings=this.videoTrack.getSettings();if(typeof ImageCapture!=='undefined'&&this.videoTrack){try{this.imageCapture=new ImageCapture(this.videoTrack);}catch(e){}}}}
connectWebSocket(token){return new Promise((resolve,reject)=>{const wsUrl=`${this.wsUrl}?token=${encodeURIComponent(token)}`;try{this.websocket=new WebSocket(wsUrl);}catch(error){reject(new Error('WebSocket 创建失败: '+error.message));return;}
const connectionTimeout=setTimeout(()=>{if(this.websocket&&this.websocket.readyState===WebSocket.CONNECTING){this.websocket.close();reject(new Error('连接超时'));}},15000);this.websocket.onopen=()=>{clearTimeout(connectionTimeout);this.reconnectAttempts=0;this.sendSetupMessage();resolve();};this.websocket.onmessage=async(event)=>{this.stats.messages++;await this.handleMessage(event);};this.websocket.onerror=(error)=>{clearTimeout(connectionTimeout);reject(new Error('WebSocket 连接失败'));};this.websocket.onclose=(event)=>{clearTimeout(connectionTimeout);this.cleanupSession();if(event.code===4001){this.onStatusChange('error','Token 无效或已过期');this.onError('Token 无效或已过期，请重新登录');this.shouldReconnect=false;}else if(this.shouldReconnect&&this.reconnectAttempts<this.maxReconnectAttempts){this.attemptReconnect();}else{this.onStatusChange('disconnected','已断开');}};});}
sendSetupMessage(){let extraHint='';if(this.mode==='audio-video'){extraHint='重要：你接收的视频是用户说话时的实时画面。请根据看到的内容进行互动。';}
const setupMessage={setup:{generationConfig:{responseModalities:['AUDIO'],speechConfig:{voiceConfig:{prebuiltVoiceConfig:{voiceName:this.selectedVoice}}},thinkingConfig:{thinkingBudget:0}},systemInstruction:extraHint?{parts:[{text:extraHint}]}:undefined}};if(!setupMessage.setup.systemInstruction){delete setupMessage.setup.systemInstruction;}
this.websocket.send(JSON.stringify(setupMessage));this.onStatusChange('connecting','等待服务器响应...');}
async handleMessage(event){let message;if(event.data instanceof Blob){const text=await event.data.text();try{message=JSON.parse(text);}catch(error){return;}}else{try{message=JSON.parse(event.data);}catch(error){return;}}
if(message.setupComplete){this.isActive=true;this.isConnecting=false;this.onStatusChange('connected','通话中');if(!this.playbackContext){this.playbackContext=new AudioContext({sampleRate:24000});this.nextPlayTime=this.playbackContext.currentTime;}
this.startAudioStream();if(this.mode==='audio-video'){this.startVideoStream();}
return;}
if(message.serverContent?.modelTurn?.parts){let hasNewAudio=false;for(const part of message.serverContent.modelTurn.parts){if(part.inlineData?.data){this.audioQueue.push(part.inlineData.data);hasNewAudio=true;this.isAIPlaying=true;}
if(part.text){const isThinking=part.text.startsWith('**')||part.text.includes('I\'m ')||part.text.includes('I\'ve ');if(!isThinking){this.onMessage({type:'text',content:part.text});}}}
if(hasNewAudio){this.processAudioQueue();}}
if(message.serverContent?.interrupted){this.audioQueue=[];this.nextPlayTime=this.playbackContext?.currentTime||0;}
if(message.serverContent?.turnComplete){}}
startAudioStream(){this.inputContext=new AudioContext({sampleRate:16000});const source=this.inputContext.createMediaStreamSource(this.mediaStream);this.audioProcessor=this.inputContext.createScriptProcessor(512,1,1);this.audioProcessor.onaudioprocess=(e)=>{if(!this.isActive||!this.websocket||this.websocket.readyState!==WebSocket.OPEN)return;const inputData=e.inputBuffer.getChannelData(0);const pcm16=new Int16Array(inputData.length);let sum=0;for(let i=0;i<inputData.length;i++){const s=Math.max(-1,Math.min(1,inputData[i]));sum+=Math.abs(inputData[i]);}
const rawVolume=sum/inputData.length;const now=Date.now();const aiPlayingCooldown=500;const isInAICooldown=this.lastAIStopTime&&(now-this.lastAIStopTime)<aiPlayingCooldown;let effectiveThreshold=this.SPEECH_THRESHOLD;if(this.isAIPlaying){effectiveThreshold=this.SPEECH_THRESHOLD*3;}else if(isInAICooldown){effectiveThreshold=this.SPEECH_THRESHOLD*2;}
const shouldMute=this.isMuted||(this.isAIPlaying&&rawVolume<effectiveThreshold);for(let i=0;i<inputData.length;i++){const s=Math.max(-1,Math.min(1,inputData[i]));pcm16[i]=shouldMute?0:(s<0?s*0x8000:s*0x7FFF);}
const avgVolume=shouldMute?0:rawVolume;this.audioHistory.push(avgVolume);if(this.audioHistory.length>this.HISTORY_WINDOW)this.audioHistory.shift();if(!this.isMuted&&avgVolume>effectiveThreshold){if(!this.isSpeaking){this.isSpeaking=true;this.speechStartTime=now;}
this.lastSpeechTime=now;const speakingDuration=now-this.speechStartTime;if(this.isAIPlaying&&speakingDuration>this.INTERRUPT_DELAY){this.interruptAI();}}else{if(this.isSpeaking&&now-this.lastSpeechTime>800){this.isSpeaking=false;this.speechStartTime=0;}}
const message={realtimeInput:{mediaChunks:[{data:this.arrayBufferToBase64(pcm16.buffer),mimeType:'audio/pcm;rate=16000'}]}};this.websocket.send(JSON.stringify(message));this.stats.audioChunks++;this.onAudioLevel(avgVolume,this.isSpeaking);};source.connect(this.audioProcessor);this.audioProcessor.connect(this.inputContext.destination);}
startVideoStream(){let canvas,ctx;const useOffscreen=typeof OffscreenCanvas!=='undefined';if(useOffscreen){canvas=new OffscreenCanvas(this.VIDEO_TARGET_SIZE,this.VIDEO_TARGET_SIZE);ctx=canvas.getContext('2d',{alpha:false});}else{canvas=document.createElement('canvas');canvas.width=this.VIDEO_TARGET_SIZE;canvas.height=this.VIDEO_TARGET_SIZE;ctx=canvas.getContext('2d',{alpha:false});}
ctx.imageSmoothingEnabled=true;const interval=1000/this.VIDEO_FPS;this.videoInterval=setInterval(async()=>{if(!this.isActive||!this.websocket||this.websocket.readyState!==WebSocket.OPEN)return;const timeSinceLastSpeech=Date.now()-this.lastSpeechTime;const recentAvg=this.audioHistory.slice(-5).reduce((a,b)=>a+b,0)/5;const shouldSend=recentAvg>this.SPEECH_THRESHOLD*0.4||this.isSpeaking||timeSinceLastSpeech<this.POST_SPEECH_BUFFER;if(!shouldSend||this.videoSendInFlight)return;if(this.websocket.bufferedAmount>this.MAX_WS_BUFFER)return;this.videoSendInFlight=true;try{let source=null;let sw=0,sh=0;if(this.imageCapture){try{const bitmap=await this.imageCapture.grabFrame();source=bitmap;sw=bitmap.width;sh=bitmap.height;}catch(e){source=null;}}
if(!source&&this.videoElement){if(this.videoElement.readyState>=2){source=this.videoElement;sw=this.videoElement.videoWidth;sh=this.videoElement.videoHeight;}}
if(!source||!sw||!sh){this.videoSendInFlight=false;return;}
let sx=0,sy=0,sSize=Math.min(sw,sh);if(sw>sh){sx=Math.floor((sw-sh)/2);}else{sy=Math.floor((sh-sw)/2);}
ctx.drawImage(source,sx,sy,sSize,sSize,0,0,this.VIDEO_TARGET_SIZE,this.VIDEO_TARGET_SIZE);if(source.close)source.close();let blob;if(useOffscreen&&canvas.convertToBlob){blob=await canvas.convertToBlob({type:'image/jpeg',quality:this.VIDEO_JPEG_QUALITY});}else{blob=await new Promise(resolve=>canvas.toBlob(resolve,'image/jpeg',this.VIDEO_JPEG_QUALITY));}
if(!blob){this.videoSendInFlight=false;return;}
const buffer=await blob.arrayBuffer();const msg={realtimeInput:{mediaChunks:[{data:this.arrayBufferToBase64(buffer),mimeType:'image/jpeg'}]}};this.websocket.send(JSON.stringify(msg));this.stats.videoFrames++;}catch(err){}finally{this.videoSendInFlight=false;}},interval);}
async processAudioQueue(){if(this.isProcessingAudio||this.audioQueue.length===0)return;this.isProcessingAudio=true;this.isAIPlaying=true;while(this.audioQueue.length>0){const base64Data=this.audioQueue.shift();try{const binaryString=atob(base64Data);const bytes=new Uint8Array(binaryString.length);for(let i=0;i<binaryString.length;i++){bytes[i]=binaryString.charCodeAt(i);}
const pcm16=new Int16Array(bytes.buffer);const audioBuffer=this.playbackContext.createBuffer(1,pcm16.length,24000);const channelData=audioBuffer.getChannelData(0);for(let i=0;i<pcm16.length;i++){channelData[i]=pcm16[i]/32768.0;}
const source=this.playbackContext.createBufferSource();source.buffer=audioBuffer;if(!this.gainNode){this.gainNode=this.playbackContext.createGain();this.gainNode.connect(this.playbackContext.destination);}
source.connect(this.gainNode);this.currentAudioSources.push(source);source.onended=()=>{const index=this.currentAudioSources.indexOf(source);if(index>-1)this.currentAudioSources.splice(index,1);if(this.currentAudioSources.length===0&&this.audioQueue.length===0){this.isAIPlaying=false;this.lastAIStopTime=Date.now();}};const currentTime=this.playbackContext.currentTime;if(this.nextPlayTime<currentTime){this.nextPlayTime=currentTime;}
source.start(this.nextPlayTime);this.nextPlayTime+=audioBuffer.duration;}catch(error){}}
this.isProcessingAudio=false;}
interruptAI(){this.audioQueue=[];for(const source of this.currentAudioSources){try{source.stop();}catch(e){}}
this.currentAudioSources=[];if(this.playbackContext){this.nextPlayTime=this.playbackContext.currentTime;}
this.isAIPlaying=false;this.lastAIStopTime=Date.now();this.isProcessingAudio=false;}
toggleMute(){this.isMuted=!this.isMuted;const audioTrack=this.mediaStream?.getAudioTracks()[0];if(audioTrack){audioTrack.enabled=!this.isMuted;}
return this.isMuted;}
setMute(muted){this.isMuted=muted;const audioTrack=this.mediaStream?.getAudioTracks()[0];if(audioTrack){audioTrack.enabled=!this.isMuted;}
return this.isMuted;}
toggleSpeakerMute(){this.speakerMuted=!this.speakerMuted;if(this.gainNode){this.gainNode.gain.setValueAtTime(this.speakerMuted?0:1,this.playbackContext?this.playbackContext.currentTime:0);}
return this.speakerMuted;}
async switchCamera(){if(this.isSwitchingCamera||!this.isActive||this.mode!=='audio-video'){return false;}
try{this.isSwitchingCamera=true;this.currentFacingMode=this.currentFacingMode==='user'?'environment':'user';if(this.videoTrack){this.videoTrack.stop();}
if(this.videoInterval){clearInterval(this.videoInterval);this.videoInterval=null;}
const newStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:this.currentFacingMode,width:{ideal:1280},height:{ideal:720},frameRate:{ideal:60}},audio:false});const newVideoTrack=newStream.getVideoTracks()[0];const audioTrack=this.mediaStream.getAudioTracks()[0];if(this.mediaStream){this.mediaStream.getVideoTracks().forEach(t=>t.stop());}
this.mediaStream=new MediaStream([audioTrack,newVideoTrack]);const videoEl=this.videoElement||document.getElementById('callVideo');if(videoEl){videoEl.srcObject=this.mediaStream;this.videoElement=videoEl;videoEl.style.transform='scaleX(1)';}
this.videoTrack=newVideoTrack;this.imageCapture=null;if(typeof ImageCapture!=='undefined'&&this.videoTrack){try{this.imageCapture=new ImageCapture(this.videoTrack);}catch(e){}}
if(this.isActive){this.startVideoStream();}
return true;}catch(error){this.onError('摄像头切换失败: '+error.message);return false;}finally{this.isSwitchingCamera=false;}}
attemptReconnect(){this.reconnectAttempts++;const delay=Math.min(1000*Math.pow(2,this.reconnectAttempts-1),30000);this.onStatusChange('reconnecting',`重连中 (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`);if(this.reconnectTimer)clearTimeout(this.reconnectTimer);this.reconnectTimer=setTimeout(async()=>{if(this.shouldReconnect){try{const token=await this.getToken(true);await this.connectWebSocket(token);}catch(error){if(this.reconnectAttempts<this.maxReconnectAttempts){this.attemptReconnect();}else{this.onStatusChange('error','重连失败，请手动重试');this.onError('重连失败');}}}},delay);}
cleanupSession(){this.isActive=false;this.isSpeaking=false;this.videoSendingActive=false;this.audioHistory=[];if(this.videoInterval){clearInterval(this.videoInterval);this.videoInterval=null;}
if(this.audioProcessor){this.audioProcessor.disconnect();this.audioProcessor=null;}
if(this.inputContext){try{this.inputContext.close();}catch(e){}
this.inputContext=null;}
this.videoSendInFlight=false;this.imageCapture=null;this.audioQueue=[];this.nextPlayTime=0;this.isProcessingAudio=false;}
stop(){this.shouldReconnect=false;if(this.reconnectTimer){clearTimeout(this.reconnectTimer);this.reconnectTimer=null;}
if(this.tokenRefreshTimer){clearTimeout(this.tokenRefreshTimer);this.tokenRefreshTimer=null;}
this.cleanupSession();if(this.playbackContext){try{this.playbackContext.close();}catch(e){}
this.playbackContext=null;}
if(this.websocket){this.websocket.close();this.websocket=null;}
this.videoTrack=null;if(this.mediaStream){this.mediaStream.getTracks().forEach(t=>t.stop());this.mediaStream=null;}
this.isConnecting=false;this.isMuted=false;this.onStatusChange('disconnected','已结束');}
getStatus(){return{isActive:this.isActive,isConnecting:this.isConnecting,mode:this.mode,voice:this.selectedVoice,isSpeaking:this.isSpeaking,isMuted:this.isMuted,cameraFacing:this.currentFacingMode,stats:{...this.stats}};}
arrayBufferToBase64(buffer){const bytes=new Uint8Array(buffer);let binary='';for(let i=0;i<bytes.byteLength;i++){binary+=String.fromCharCode(bytes[i]);}
return btoa(binary);}}
LiveCall.prewarm=async function(options={}){const wsUrl=options.wsUrl||'wss://ailive.wawacm.com';const tokenEndpoint=options.tokenEndpoint||'/api/live-token.php';const result={server:false,token:false,error:null};try{const serverUrl=wsUrl.replace('wss://','https://').replace('ws://','http://');const prewarmPromise=fetch(`${serverUrl}/prewarm`,{method:'GET',mode:'cors',cache:'no-store'}).then(res=>{result.server=res.ok;return res.json().catch(()=>({}));}).catch(err=>{console.warn('[LiveCall] 服务器预热失败:',err.message);result.server=false;});const tokenPromise=fetch(`${tokenEndpoint}/get-token`,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include'}).then(res=>{result.token=res.status===200||res.status===403;return res.json().catch(()=>({}));}).catch(err=>{console.warn('[LiveCall] Token 预热失败:',err.message);result.token=false;});await Promise.allSettled([prewarmPromise,tokenPromise]);console.log(`[LiveCall] 预热完成: 服务器=${result.server?'✓':'✗'}, Token=${result.token?'✓':'✗'}`);}catch(err){console.error('[LiveCall] 预热异常:',err);result.error=err.message;}
return result;};if(typeof module!=='undefined'&&module.exports){module.exports=LiveCall;}
if(typeof window!=='undefined'){window.LiveCall=LiveCall;}