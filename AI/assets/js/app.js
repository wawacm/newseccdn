class WAWAAIApp{constructor(){this.currentUser=null,this.currentSession=null,this.attachments=[],this.isLoading=!1,this.searchAutoEnabled=!1,this.accessControl=new AccessControl,this.init()}async init(){if(window.IS_ADMIN_PAGE)return void this.initNotification();await this.accessControl.checkAccess(),this.bindEvents(),this.checkAuth(),this.autoResizeTextarea(),this.initMobileFeatures(),this.initPasteAndDrop(),this.initNotification(),this.initLoginStatusCheck(),this.initSearchButton(),this.initImagePreview(),document.addEventListener("keydown",(e=>{if("Escape"===e.key){const e=document.querySelector(".sidebar");e&&e.classList.contains("mobile-open")&&this.forceCloseSidebar()}}));const e=document.getElementById("emergencyCloseBtn");e&&e.remove()}initNotification(){const e=document.getElementById("notificationClose");e&&e.addEventListener("click",(()=>this.hideNotification()))}initLoginStatusCheck(){setInterval((async()=>{if(this.currentUser&&!document.getElementById("loginPage").classList.contains("active"))try{(await this.apiCall("/auth/user")).success||this.handleLoginExpired()}catch(e){}}),3e5)}toggleMobileSidebar(){const e=document.querySelector(".sidebar"),t=document.getElementById("sidebarOverlay");if(e){if(!t){const e=document.createElement("div");e.id="sidebarOverlay",e.className="sidebar-overlay",e.addEventListener("click",(()=>this.closeMobileSidebar())),document.body.appendChild(e)}e.classList.contains("mobile-open")?this.closeMobileSidebar():(e.classList.add("mobile-open"),document.getElementById("sidebarOverlay").classList.add("active"),document.body.style.overflow="hidden")}}closeMobileSidebar(){const e=document.querySelector(".sidebar"),t=document.getElementById("sidebarOverlay");e&&e.classList.remove("mobile-open"),t&&t.classList.remove("active"),document.body.style.overflow=""}bindEvents(){document.getElementById("loginForm").addEventListener("submit",(e=>this.handleLogin(e))),document.getElementById("registerForm").addEventListener("submit",(e=>this.handleRegister(e))),document.querySelectorAll(".tab-btn").forEach((e=>{e.addEventListener("click",(e=>this.switchAuthTab(e)))})),document.getElementById("newChatBtn").addEventListener("click",(()=>this.createNewSession())),document.getElementById("sendBtn").addEventListener("click",(()=>this.sendMessage())),document.getElementById("messageInput").addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.isLoading?this.showNotification("WaWa AIæ­£åœ¨å›å¤ä¸­...è¯·ç¨ç­‰","warning"):this.sendMessage())})),document.getElementById("messageInput").addEventListener("input",(()=>this.updateSendButton())),this.initMobileInputAdaptation(),this.initLoginInputAdaptation(),document.getElementById("editTitleBtn").addEventListener("click",(()=>this.editSessionTitle())),document.getElementById("attachBtn").addEventListener("click",(()=>{document.getElementById("fileInput").click()})),document.getElementById("fileInput").addEventListener("change",(e=>this.handleFileUpload(e))),document.getElementById("searchToggle").addEventListener("change",(e=>{this.handleSearchToggle(e)}));const e=document.getElementById("modelSelector");e&&e.addEventListener("change",(e=>{this.handleModelChange(e)}));const t=document.getElementById("settingsBtn");t&&t.addEventListener("click",(()=>{window.location.href="cmofwawa.php"}));const s=document.getElementById("closeSessionModal"),i=document.getElementById("closeSessionModalBtn");s&&s.addEventListener("click",(()=>{document.getElementById("sessionDetailModal").style.display="none"})),i&&i.addEventListener("click",(()=>{document.getElementById("sessionDetailModal").style.display="none"})),document.getElementById("logoutBtn").addEventListener("click",(()=>this.logout())),document.getElementById("searchInput").addEventListener("input",(e=>this.searchSessions(e.target.value))),document.getElementById("modelSelect").addEventListener("change",(e=>this.updateModelDisplay(e)));const n=document.getElementById("voiceCallBtn");n&&n.addEventListener("click",(()=>this.showDevelopmentNotice("è¯­éŸ³é€šè¯")));const o=document.getElementById("videoCallBtn");o&&o.addEventListener("click",(()=>this.showDevelopmentNotice("è§†é¢‘é€šè¯")));const a=document.getElementById("moreOptionsBtn");a&&a.addEventListener("click",(()=>this.toggleMobileSidebar()));const c=document.getElementById("mobileCloseBtn");c&&c.addEventListener("click",(()=>this.forceCloseSidebar())),document.querySelector(".close").addEventListener("click",(()=>this.closeModal())),document.getElementById("notificationClose").addEventListener("click",(()=>this.hideNotification())),window.addEventListener("click",(e=>{const t=document.getElementById("modal");e.target===t&&this.closeModal()}))}initMobileFeatures(){this.isMobile=window.innerWidth<=768,window.addEventListener("resize",(()=>{const e=this.isMobile;this.isMobile=window.innerWidth<=768,e!==this.isMobile&&this.handleMobileToggle()})),this.setupMobileSidebar(),this.setupTouchOptimizations()}setupMobileSidebar(){const e=document.querySelector(".sidebar"),t=(document.querySelector(".main-chat"),document.querySelector(".chat-header")),s=(document.querySelector(".model-selector"),document.getElementById("mobileSidebarToggle"));s&&s.remove();const i=document.createElement("button");if(i.id="mobileSidebarToggle",i.className="btn-icon",i.innerHTML='<i class="fas fa-bars"></i>',i.style.cssText="\n            width: auto;\n            height: auto;\n            padding: 8px 12px;\n            margin-right: 10px;\n            cursor: pointer;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            background: transparent;\n            color: var(--text-primary);\n            border: none;\n        ",t){const e=t.querySelector(".chat-title");t.insertBefore(i,e)}const n=document.getElementById("mobileSidebarToggle");n&&n.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),setTimeout((()=>{this.toggleMobileSidebar()}),0)})),this.setupOutsideClickListener(),e&&e.addEventListener("click",(e=>{e.stopPropagation()}))}toggleMobileSidebar(){const e=document.querySelector(".sidebar"),t=document.getElementById("mobileSidebarToggle");e&&setTimeout((()=>{const s=(e.getAttribute("class")||"").includes("mobile-open"),i=e.classList.contains("mobile-open"),n=window.getComputedStyle(e),o=n.transform&&(n.transform.includes("translateY(0")||"matrix(1, 0, 0, 1, 0, 0)"===n.transform)&&"1"===n.opacity;s||i||o?(e.classList.remove("mobile-open"),e.className=e.className.replace(/mobile-open/g,"").replace(/\s+/g," ").trim(),e.style.transform="",e.style.opacity="",e.style.visibility="",t&&(t.innerHTML='<i class="fas fa-bars"></i>')):(e.className="sidebar mobile-open",t&&(t.innerHTML='<i class="fas fa-times"></i>'),e.style.transform="translateY(0)",e.style.opacity="1",e.style.visibility="visible")}),5)}openMobileSidebar(){const e=document.querySelector(".sidebar"),t=document.getElementById("mobileSidebarToggle");e&&e.classList.add("mobile-open"),t&&(t.innerHTML='<i class="fas fa-times"></i>')}closeMobileSidebar(){const e=document.querySelector(".sidebar"),t=document.getElementById("mobileSidebarToggle");e&&(e.classList.remove("mobile-open"),t&&(t.innerHTML='<i class="fas fa-bars"></i>'))}forceCloseSidebar(){const e=document.querySelector(".sidebar"),t=document.getElementById("mobileSidebarToggle");e&&(e.classList.remove("mobile-open"),e.className="sidebar",e.style.transform="",e.style.opacity="",e.style.visibility=""),t&&(t.innerHTML='<i class="fas fa-bars"></i>')}addEmergencyCloseButton(){const e=document.getElementById("emergencyCloseBtn");e&&e.remove();const t=document.createElement("button");t.id="emergencyCloseBtn",t.innerHTML="âœ• å…³é—­ä¾§è¾¹æ ",t.style.cssText="\n            position: fixed;\n            top: 10px;\n            right: 10px;\n            z-index: 9999;\n            background: #ff4444;\n            color: white;\n            border: none;\n            padding: 10px 15px;\n            border-radius: 5px;\n            cursor: pointer;\n            font-size: 14px;\n            font-weight: bold;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.3);\n            display: none;\n        ",t.addEventListener("click",(e=>{e.stopPropagation(),this.forceCloseSidebar()})),document.body.appendChild(t);const s=document.querySelector(".sidebar");if(s){new MutationObserver((()=>{s.classList.contains("mobile-open")?t.style.display="block":t.style.display="none"})).observe(s,{attributes:!0})}}setupOutsideClickListener(){this.outsideClickHandler&&document.removeEventListener("click",this.outsideClickHandler,!0),this.outsideClickHandler=e=>{const t=document.querySelector(".sidebar"),s=document.getElementById("mobileSidebarToggle");if(t){if((t.getAttribute("class")||"").includes("mobile-open")){let i=!1;if(t.contains(e.target)&&(i=!0),s){(s.contains(e.target)||s===e.target)&&(i=!0);const t=s.querySelector("i");t&&(t.contains(e.target)||t===e.target)&&(i=!0)}i||this.forceCloseSidebar()}}},document.addEventListener("click",this.outsideClickHandler,!0)}handleMobileToggle(){const e=document.querySelector(".sidebar");if(this.isMobile)this.setupMobileSidebar();else{const t=document.getElementById("mobileSidebarToggle");t&&t.remove(),e&&e.classList.remove("mobile-open"),this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler,!0),this.outsideClickHandler=null)}}setupTouchOptimizations(){let e=0;if(document.addEventListener("touchend",(t=>{const s=(new Date).getTime();s-e<=300&&t.preventDefault(),e=s}),!1),this.isMobile){let e=0,t=0,s=0,i=0;document.addEventListener("touchstart",(s=>{e=s.touches[0].clientX,t=s.touches[0].clientY})),document.addEventListener("touchmove",(n=>{if(!e||!t)return;s=n.touches[0].clientX,i=n.touches[0].clientY;const o=e-s,a=t-i;if(Math.abs(o)>Math.abs(a)){const t=document.querySelector(".sidebar");o<-50&&e<50?this.openMobileSidebar():o>50&&t&&t.classList.contains("mobile-open")&&this.closeMobileSidebar()}})),document.addEventListener("touchend",(()=>{e=0,t=0,s=0,i=0}))}}async checkAuth(){if(this.accessControl&&!this.accessControl.isLoggedIn&&this.accessControl.isPublicDomain&&!this.accessControl.isApiDomain)return this.currentUser=null,void this.showChatPage();try{const e=await this.apiCall("/auth/user");e.success?(this.currentUser=e.user,this.showChatPage(),this.loadSessions()):this.accessControl&&this.accessControl.isPublicDomain&&!this.accessControl.isApiDomain?(this.currentUser=null,this.showChatPage()):this.showLoginPage()}catch(e){this.accessControl&&this.accessControl.isPublicDomain&&!this.accessControl.isApiDomain?(this.currentUser=null,this.showChatPage()):this.showLoginPage()}}async apiCall(e,t={}){const s=`api${e}`,i="/chat/messages"===e&&"POST"===t.method,n=["/generate-image","/kolors","/banana"].includes(e),o=i||n?18e4:15e3,a={method:"GET",headers:{"Content-Type":"application/json","Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},credentials:"same-origin",...t};a.body&&"object"==typeof a.body&&(a.body=JSON.stringify(a.body));const c=new AbortController,r=setTimeout((()=>c.abort()),o);a.signal=c.signal;try{const t=await fetch(s,a);if(clearTimeout(r),401===t.status){const t="/s4/presign"===e||"/upload"===e,s="/s4/delete"===e,i=this.accessControl&&this.accessControl.isPublicDomain&&!this.accessControl.isApiDomain&&!this.currentUser;throw(t||s)&&i||this.handleLoginExpired(),new Error("ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•")}if(503===t.status)throw new Error("æœåŠ¡å™¨ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");if(504===t.status)throw new Error("è¯·æ±‚è¶…æ—¶ï¼ŒæœåŠ¡å™¨å“åº”è¿‡æ…¢ï¼Œè¯·ç¨åé‡è¯•");const n=t.headers.get("content-type");if(!n||!n.includes("application/json")){const e=await t.text();if(i&&""===e.trim())throw await new Promise((e=>setTimeout(e,1e3))),new Error("å“åº”ä¸ºç©ºï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹æ¶ˆæ¯");throw new Error("æœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„å“åº”")}let o;try{o=await t.json()}catch(e){if(i)throw new Error("å“åº”è§£æå¤±è´¥ï¼Œæ¶ˆæ¯å¯èƒ½å·²ä¿å­˜ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹");throw new Error("å“åº”ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼")}if(!t.ok)throw new Error(o.error||"è¯·æ±‚å¤±è´¥");return o}catch(e){if(clearTimeout(r),"AbortError"===e.name)throw new Error(`è¯·æ±‚è¶…æ—¶ï¼ˆ${o/1e3}ç§’ï¼‰ï¼ŒæœåŠ¡å™¨å“åº”è¿‡æ…¢ï¼Œè¯·ç¨åé‡è¯•`);if(e.message.includes("Failed to fetch")||e.message.includes("NetworkError"))throw new Error("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•");throw e}}handleLoginExpired(){this.accessControl&&this.accessControl.isPublicDomain&&!this.accessControl.isApiDomain&&!this.currentUser||(this.currentUser=null,this.currentSession=null,this.attachments=[],this.isLoading=!1,this.clearUserData(),this.resetAllUIElements(),this.showNotification("ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•","warning"),setTimeout((()=>{this.showLoginPage()}),1500))}showNotification(e,t="info"){const s=document.getElementById("notification"),i=document.getElementById("notificationText");s&&i&&(i.textContent=e,s.className=`notification ${t}`,s.offsetHeight,setTimeout((()=>{s.classList.add("show")}),10),clearTimeout(this.notificationTimeout),this.notificationTimeout=setTimeout((()=>{this.hideNotification()}),4e3))}hideNotification(){const e=document.getElementById("notification");e&&e.classList.remove("show")}showPage(e){document.querySelectorAll(".page").forEach((e=>{e.classList.remove("active")})),document.getElementById(e).classList.add("active")}showLoginPage(){this.showPage("loginPage")}showChatPage(){this.showPage("chatPage");const e=document.getElementById("settingsBtn");this.currentUser?(document.getElementById("currentUsername").textContent=this.currentUser.username,this.currentUser.is_admin?e.style.display="flex":e.style.display="none",this.updateModelSelector(),this.resetChatInterface()):(document.getElementById("currentUsername").textContent="æ¸¸å®¢",e&&(e.style.display="none"),this.updateModelSelector())}resetChatInterface(){this.currentSession=null;const e=document.getElementById("currentSessionTitle");e&&(e.textContent="AIæ™ºèƒ½åŠ©æ‰‹");const t=document.getElementById("editTitleBtn");t&&(t.style.display="none"),this.showWelcomeMessage();const s=document.getElementById("messageInput");s&&(s.value="",s.disabled=!1,s.placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯... (æ”¯æŒ Ctrl+V ç²˜è´´å›¾ç‰‡)",s.style.pointerEvents="auto");const i=document.getElementById("sendBtn");i&&(i.disabled=!0,i.innerHTML='<i class="fas fa-paper-plane"></i>');const n=document.getElementById("attachBtn");n&&(n.disabled=!1),this.attachments=[],this.updateAttachmentPreview(),this.isLoading=!1,this.removeThinkingMessage()}updateModelSelector(){document.getElementById("modelSelect")}switchAuthTab(e){const t=e.target.dataset.tab;document.querySelectorAll(".tab-btn").forEach((e=>{e.classList.remove("active")})),e.target.classList.add("active"),document.querySelectorAll(".auth-form").forEach((e=>{e.classList.remove("active")})),document.getElementById(`${t}Form`).classList.add("active")}async handleLogin(e){e.preventDefault();const t=document.getElementById("loginUsername").value,s=document.getElementById("loginPassword").value;if(t&&s)try{const e=await this.apiCall("/auth/login",{method:"POST",body:{username:t,password:s}});e.success?(this.currentUser=e.user,this.clearUserData(),this.showNotification("ç™»å½•æˆåŠŸ","success"),e.last_login_time&&setTimeout((()=>{const t=this.formatLastLoginTime(e.last_login_time);this.showNotification(`ä¸Šæ¬¡ç™»å½•æ—¶é—´ï¼š${t}`,"info",5e3)}),1500),this.showChatPage(),setTimeout((()=>{this.loadSessions()}),100)):this.showNotification(e.message,"error")}catch(e){this.showNotification(e.message,"error")}else this.showNotification("è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ","error")}clearUserData(){this.currentSession=null,this.attachments=[],this.isLoading=!1;const e=document.getElementById("sessionList");e&&(e.innerHTML="");const t=document.getElementById("chatMessages");t&&(t.innerHTML=""),document.querySelectorAll('[data-is-temp="true"]').forEach((e=>{e.remove()})),this.removeThinkingMessage()}async handleRegister(e){e.preventDefault();const t=document.getElementById("registerUsername").value,s=document.getElementById("registerEmail").value,i=document.getElementById("registerPassword").value,n=document.getElementById("confirmPassword").value;if(t&&i)if(i===n)try{const e=await this.apiCall("/auth/register",{method:"POST",body:{username:t,email:s,password:i}});e.success?(this.showNotification("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•","success"),document.querySelector('.tab-btn[data-tab="login"]').click(),document.getElementById("registerForm").reset()):this.showNotification(e.message,"error")}catch(e){this.showNotification(e.message,"error")}else this.showNotification("ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´","error");else this.showNotification("è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ","error")}async logout(){try{await this.apiCall("/auth/logout"),this.clearUserData(),this.currentUser=null,this.resetAllUIElements(),this.showNotification("å·²é€€å‡ºç™»å½•","success"),this.showLoginPage()}catch(e){this.showNotification(e.message,"error")}}resetAllUIElements(){const e=document.getElementById("modelSelect");e&&(e.value="wawa-ai-auto"),this.updateAttachmentPreview(),this.closeMobileSidebar()}showDevelopmentNotice(e){this.showNotification(`ğŸš§ ${e}åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼`,"info")}updateModelDisplay(e){const t=e.target.value,s=document.getElementById("currentModelDisplay");if(s){const e={"wawa-ai-auto":"Wawa AI Auto"};s.textContent=e[t]||"Wawa&Gemin"}}async updateSessionListOnly(){try{const e=Date.now(),t=await this.apiCall(`/chat/sessions?_t=${e}`);t.success&&this.renderSessions(t.sessions||[])}catch(e){}}highlightCurrentSession(e){document.querySelectorAll(".session-item").forEach((e=>{e.classList.remove("active")}));const t=document.querySelector(`[data-session-id="${e}"]`);t&&t.classList.add("active"),this.closeMobileSidebar(),this.isMobile&&this.closeMobileSidebar()}async loadSessions(){if(this.currentUser||"undefined"==typeof anonymousStorage)try{const e=Date.now(),t=await this.apiCall(`/chat/sessions?_t=${e}`);t.success?this.renderSessions(t.sessions||[]):this.currentUser&&this.showNotification("åŠ è½½ä¼šè¯å¤±è´¥","error")}catch(e){this.currentUser&&this.showNotification("åŠ è½½ä¼šè¯å¤±è´¥","error")}else{const e=anonymousStorage.getSessions();this.renderSessions(e)}}renderSessions(e){const t=document.getElementById("sessionList");t.innerHTML="",e&&0!==e.length&&e.forEach(((e,s)=>{const i=document.createElement("div");i.className="session-item",i.dataset.sessionId=e.id,this.currentSession&&this.currentSession.id==e.id&&i.classList.add("active"),i.addEventListener("click",(()=>this.selectSession(e))),i.innerHTML=`\n                <div class="session-item-title">${e.title}</div>\n                <div class="session-item-preview">${this.sanitizePreviewText(e.last_message||"æš‚æ— æ¶ˆæ¯")}</div>\n                <div class="session-item-actions">\n                    <button class="session-delete-btn" onclick="event.stopPropagation(); app.deleteSession(${e.id});" title="åˆ é™¤">\n                        <i class="fas fa-trash"></i>\n                    </button>\n                </div>\n            `,t.appendChild(i)}))}async createNewSession(){if(!this.currentUser&&"undefined"!=typeof anonymousStorage){const e=anonymousStorage.createSession("æ–°å¯¹è¯");if(e){this.currentSession=e,this.currentSession.messages=[],document.getElementById("currentSessionTitle").textContent=e.title;const t=document.getElementById("chatMessages");return t&&(t.innerHTML=""),this.showWelcomeMessage(),void this.loadSessions()}return void this.showNotification("åˆ›å»ºä¼šè¯å¤±è´¥","error")}const e={id:"temp-"+Date.now(),title:"æ–°å¯¹è¯",messages:[],isTemp:!0};this.selectSession(e),this.addTempSessionToList(e);try{const t=await this.apiCall("/chat/sessions",{method:"POST",body:{title:"æ–°å¯¹è¯"}});if(t.success){const s={id:t.session_id,title:t.title,messages:[]};this.currentSession=s,document.getElementById("currentSessionTitle").textContent=s.title,this.removeTempSessionFromList(e.id),await this.updateSessionListOnly(),this.highlightCurrentSession(s.id)}else this.removeTempSessionFromList(e.id),this.showNotification("åˆ›å»ºä¼šè¯å¤±è´¥: "+(t.message||""),"error")}catch(t){this.removeTempSessionFromList(e.id),this.showNotification("åˆ›å»ºä¼šè¯å¤±è´¥","error")}}addTempSessionToList(e){const t=document.getElementById("sessionList"),s=document.createElement("div");s.className="session-item active",s.dataset.sessionId=e.id,s.dataset.isTemp="true",s.innerHTML=`\n            <div class="session-item-title">${e.title}</div>\n            <div class="session-item-preview">æ­£åœ¨åˆ›å»º...</div>\n            <div class="session-item-actions">\n                <div class="session-loading">\n                    <i class="fas fa-spinner fa-spin"></i>\n                </div>\n            </div>\n        `,t.insertBefore(s,t.firstChild),document.querySelectorAll(".session-item").forEach((e=>{e!==s&&e.classList.remove("active")}))}removeTempSessionFromList(e){const t=document.querySelector(`[data-session-id="${e}"]`);t&&"true"===t.dataset.isTemp&&t.remove()}async selectSession(e){const t=this.currentSession?this.currentSession.id:null;if(this.isMobile&&t===e.id){if(document.getElementById("chatMessages").querySelectorAll(".message:not(.welcome-message)").length>0)return void this.closeMobileSidebar()}this.currentSession=e,document.getElementById("currentSessionTitle").textContent=e.title,document.getElementById("editTitleBtn").style.display="flex",document.querySelectorAll(".session-item").forEach((e=>{e.classList.remove("active")}));const s=document.querySelector(`[data-session-id="${e.id}"]`);s&&s.classList.add("active"),this.closeMobileSidebar(),e.isTemp||(this.showLoadingMessages(),await this.loadMessages(e.id))}async editSessionTitle(){if(!this.currentSession)return void this.showNotification("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä¼šè¯","error");const e=this.currentSession.title,t=prompt("è¯·è¾“å…¥æ–°çš„ä¼šè¯æ ‡é¢˜:",e);if(t&&""!==t.trim()&&t!==e)try{const e=await this.apiCall("/chat/session",{method:"PUT",body:{session_id:this.currentSession.id,title:t.trim()}});e.success?(this.currentSession.title=t.trim(),document.getElementById("currentSessionTitle").textContent=t.trim(),this.loadSessions(),this.showNotification("ä¼šè¯æ ‡é¢˜å·²æ›´æ–°","success")):this.showNotification(e.message||"æ›´æ–°æ ‡é¢˜å¤±è´¥","error")}catch(e){this.showNotification("æ›´æ–°æ ‡é¢˜å¤±è´¥: "+e.message,"error")}}async loadMessages(e){if(this.currentUser||"undefined"==typeof anonymousStorage)try{const t=await this.apiCall(`/chat/messages?session_id=${e}`);t.success?this.renderMessages(t.messages):this.showWelcomeMessage()}catch(e){this.currentUser&&this.showNotification("åŠ è½½æ¶ˆæ¯å¤±è´¥","error"),this.showWelcomeMessage()}else{const t=anonymousStorage.getMessages(e);t.length>0?this.renderMessages(t):this.showWelcomeMessage()}}renderMessages(e){document.getElementById("chatMessages").innerHTML="",e&&0!==e.length?(e.forEach((e=>{this.addMessageToUI(e)})),this.scrollToBottom(),setTimeout((()=>{this.renderMathFormulas()}),10)):this.showWelcomeMessage()}showWelcomeMessage(){document.getElementById("chatMessages").innerHTML='\n            <div class="welcome-message">\n                <div class="welcome-icon">\n                    <i class="fas fa-robot"></i>\n                </div>\n                <h3>æ¬¢è¿ä½¿ç”¨ WawaCloud AI èŠå¤©åŠ©æ‰‹</h3>\n                <p>æˆ‘æ˜¯å¨ƒå¨ƒå›¢é˜Ÿæ——ä¸‹è¶…çº§AIï¼Œèåˆäº†å…¨çƒé¡¶å°–å¤§æ¨¡å‹ï¼</p>\n                <p>æˆ‘ä¼šæ ¹æ®ä½ çš„é—®é¢˜ï¼Œè‡ªåŠ¨åˆ†é…å¯¹åº”çš„Aiæ¨¡å‹ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºwawa AI</p>\n                <div class="feature-list">\n                    <div class="feature-item">\n                        <i class="fas fa-image"></i>\n                        <span>å›¾ç‰‡åˆ†æ</span>\n                    </div>\n                    <div class="feature-item">\n                        <i class="fas fa-palette"></i>\n                        <span>AIç»˜å›¾</span>\n                    </div>\n                    <div class="feature-item">\n                        <i class="fas fa-brain"></i>\n                        <span>æ™ºèƒ½æ¨ç†</span>\n                    </div>\n                    <div class="feature-item">\n                        <i class="fas fa-file-alt"></i>\n                        <span>æ–‡æ¡£å¤„ç†</span>\n                    </div>\n                </div>\n\n            </div>\n        '}showLoadingMessages(){document.getElementById("chatMessages").innerHTML='\n            <div class="welcome-message">\n                <div class="welcome-icon">\n                    <i class="fas fa-spinner fa-spin"></i>\n                </div>\n                <h3>åŠ è½½æ¶ˆæ¯ä¸­...</h3>\n                <p>æ­£åœ¨è·å–å†å²å¯¹è¯å†…å®¹</p>\n            </div>\n        '}addMessageToUI(e){const t=document.getElementById("chatMessages"),s=t.querySelector(".welcome-message");s&&s.remove();const i=document.createElement("div");i.className=`message ${e.role}`;const n="user"===e.role?'<i class="fas fa-user"></i>':'<i class="fas fa-robot"></i>';let o="";e.attachments&&e.attachments.length>0&&(o='<div class="message-attachments">',e.attachments.forEach(((e,t)=>{const s=this.getFileIcon(e.category),i="images"===e.category;Date.now();o+=i?`\n                        <div class="image-attachment-container">\n                            <div class="attachment-item image-attachment" data-image-url="${e.url}" onclick="app.showImagePreview('${e.url}', '${e.name}')">\n                                <i class="${s}"></i>\n                                <span class="attachment-name">${e.name}</span>\n                                <i class="fas fa-search-plus preview-icon"></i>\n                            </div>\n                            <img class="image-thumbnail" src="${e.url}" alt="${e.name}" onclick="app.showImagePreview('${e.url}', '${e.name}')" onerror="this.style.display='none'">\n                        </div>\n                    `:`\n                        <div class="attachment-item">\n                            <i class="${s}"></i>\n                            <span>${e.name}</span>\n                        </div>\n                    `})),o+="</div>");let a="";if("assistant"===e.role&&e.thinking_content&&e.has_thinking){const t=`thinking-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;a=`\n                <div class="thinking-section" id="${t}">\n                    <div class="thinking-header" onclick="app.toggleThinkingContent('${t}')">\n                        <i class="fas fa-brain thinking-icon"></i>\n                        <span class="thinking-label">AI æ€è€ƒè¿‡ç¨‹</span>\n                        <i class="fas fa-chevron-down thinking-toggle"></i>\n                    </div>\n                    <div class="thinking-body" style="display: none;">\n                        <div class="thinking-text">${this.escapeHtml(e.thinking_content)}</div>\n                    </div>\n                </div>\n            `}const c=e.content.includes('<div class="generated-image">')||e.content.includes('<img src="data:')||e.content.includes('<div class="')||e.content.includes("<img ")||e.content.includes('<p class="')||e.content.includes('<span class="')?e.content:this.formatMessageText(e.content);let r="";"assistant"===e.role&&e.is_proxy&&(r='<span class="proxy-badge" title="é€šè¿‡ä»£ç†æœåŠ¡å™¨å“åº”"><i class="fas fa-server"></i></span>'),i.innerHTML=`\n            <div class="message-avatar">${n}</div>\n            <div class="message-content">\n                ${o}\n                ${a}\n                <div class="message-bubble">\n                    <div class="message-text">${c}</div>\n                    <div class="message-time">${this.formatTime(e.created_at)}${r}</div>\n                </div>\n            </div>\n        `,t.appendChild(i),setTimeout((()=>{this.renderMathFormulas()}),10)}formatMessageText(e){e=this.processCodeBlocks(e),e=this.processMathFormulas(e);let t="";for(;e.includes("![")&&e.includes("](")&&e!==t;){t=e;const s=e.indexOf("!["),i=e.indexOf("](",s);if(-1===i)break;let n=1,o=i+2,a=!1;const c=Math.min(e.length,o+5e5);for(;o<c;)if("("===e[o]?n++:")"===e[o]&&n--,o++,0===n){a=!0;break}if(!a){e=e.substring(0,s)+"&#33;["+e.substring(s+2);continue}const r=e.substring(s+2,i);0;const l=`<div class="generated-image"><img src="${e.substring(i+2,o-1)}" alt="${r||"Generated Image"}" /><p class="image-prompt">AIç”Ÿæˆå›¾ç‰‡</p></div>`;e=e.substring(0,s)+l+e.substring(o)}return e=e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`(.*?)`/g,"<code>$1</code>").replace(/\n/g,"<br>")}processMathFormulas(e){return e=(e=e.replace(/(?<!\$)\$(?!\$)([^$\n]+?)\$(?!\$)/g,((e,t)=>'<span class="math-formula inline" id="'+("math-"+Date.now()+"-"+Math.random().toString(36).substr(2,9))+'" data-formula="'+this.escapeHtml(t)+'">$'+this.escapeHtml(t)+"$</span>"))).replace(/\$\$([\s\S]*?)\$\$/g,((e,t)=>'<div class="math-formula display" id="'+("math-"+Date.now()+"-"+Math.random().toString(36).substr(2,9))+'" data-formula="'+this.escapeHtml(t.trim())+'">$$'+this.escapeHtml(t.trim())+"$$</div>"))}renderMathFormulas(){document.querySelectorAll(".math-formula[data-formula]").forEach((e=>{const t=e.getAttribute("data-formula"),s=e.classList.contains("display");try{window.katex&&(katex.render(t,e,{displayMode:s,throwOnError:!1,strict:!1,trust:!1}),e.removeAttribute("data-formula"))}catch(e){}}))}processCodeBlocks(e){return e.replace(/```([a-zA-Z]*)(\r?\n)?([\s\S]*?)```/g,((e,t,s,i)=>{i=i.trim();const n=this.escapeHtml(i),o="code-block-"+Date.now()+"-"+Math.random().toString(36).substr(2,9);return'<div class="code-block-container" data-language="'+(t||"text")+'"><div class="code-block-header"><span class="code-language">'+(t||"Text")+'</span><div class="code-actions"><button class="code-action-btn" onclick="app.copyCodeBlock(\''+o+'\')" title="å¤åˆ¶ä»£ç "><i class="fas fa-copy"></i></button><button class="code-action-btn" onclick="app.editCodeBlock(\''+o+"', '"+(t||"text")+'\')" title="ç¼–è¾‘ä»£ç "><i class="fas fa-edit"></i></button><button class="code-action-btn" onclick="app.fullscreenCodeBlock(\''+o+'\')" title="å…¨å±æŸ¥çœ‹"><i class="fas fa-expand"></i></button></div></div><pre class="code-block" id="'+o+'"><code>'+n+"</code></pre></div>"}))}escapeHtml(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,(function(e){return t[e]}))}sanitizePreviewText(e){return e&&"string"==typeof e?((e=(e=(e=(e=e.replace(/```[\s\S]*?```/g,"[ä»£ç å—]")).replace(/`[^`]*`/g,"[ä»£ç ]")).replace(/<[^>]*>/g,"")).replace(/\s+/g," ").trim()).length>50&&(e=e.substring(0,50)+"..."),e||"æš‚æ— æ¶ˆæ¯"):"æš‚æ— æ¶ˆæ¯"}copyCodeBlock(e){const t=document.getElementById(e);if(t){const e=t.textContent;navigator.clipboard.writeText(e).then((()=>{this.showNotification("ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿","success")})).catch((()=>{const t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),this.showNotification("ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿","success")}))}}editCodeBlock(e,t){const s=document.getElementById(e);if(s){const i=s.textContent;this.showCodeEditor(i,t,e)}}fullscreenCodeBlock(e){const t=document.getElementById(e);if(t){const e=t.textContent,s=t.closest(".code-block-container").dataset.language;this.showFullscreenCode(e,s)}}showCodeEditor(e,t,s){const i=document.createElement("div");i.className="code-editor-modal",i.innerHTML='<div class="code-editor-overlay" onclick="this.parentElement.remove()"></div><div class="code-editor-container"><div class="code-editor-header"><h3>ç¼–è¾‘ä»£ç  - '+t.toUpperCase()+'</h3><button class="close-btn" onclick="this.closest(\'.code-editor-modal\').remove()"><i class="fas fa-times"></i></button></div><div class="code-editor-body"><textarea class="code-editor-textarea" placeholder="åœ¨æ­¤ç¼–è¾‘ä»£ç ...">'+this.escapeHtml(e)+'</textarea></div><div class="code-editor-actions"><button class="btn btn-secondary" onclick="this.closest(\'.code-editor-modal\').remove()">å–æ¶ˆ</button><button class="btn btn-primary" onclick="app.saveCodeEdit(\''+s+'\', this)">ä¿å­˜</button><button class="btn btn-success" onclick="app.copyFromEditor(this)">å¤åˆ¶</button></div></div>',document.body.appendChild(i),setTimeout((()=>{i.querySelector(".code-editor-textarea").focus()}),100)}showFullscreenCode(e,t){const s=document.createElement("div");s.className="code-fullscreen-modal",s.innerHTML='<div class="code-fullscreen-overlay" onclick="this.parentElement.remove()"></div><div class="code-fullscreen-container"><div class="code-fullscreen-header"><h3>'+t.toUpperCase()+' ä»£ç </h3><div class="code-fullscreen-actions"><button class="code-action-btn" onclick="app.copyFromFullscreen(this)" title="å¤åˆ¶ä»£ç "><i class="fas fa-copy"></i> å¤åˆ¶</button><button class="close-btn" onclick="this.closest(\'.code-fullscreen-modal\').remove()" title="å…³é—­"><i class="fas fa-times"></i></button></div></div><div class="code-fullscreen-body"><pre class="code-fullscreen-block"><code>'+this.escapeHtml(e)+"</code></pre></div></div>",document.body.appendChild(s)}saveCodeEdit(e,t){const s=t.closest(".code-editor-modal"),i=s.querySelector(".code-editor-textarea").value,n=document.getElementById(e);n&&(n.textContent=i),s.remove(),this.showNotification("ä»£ç å·²æ›´æ–°","success")}copyFromEditor(e){const t=e.closest(".code-editor-modal").querySelector(".code-editor-textarea"),s=t.value;navigator.clipboard.writeText(s).then((()=>{this.showNotification("ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿","success")})).catch((()=>{t.select(),document.execCommand("copy"),this.showNotification("ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿","success")}))}copyFromFullscreen(e){const t=e.closest(".code-fullscreen-modal").querySelector(".code-fullscreen-block").textContent;navigator.clipboard.writeText(t).then((()=>{this.showNotification("ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿","success")})).catch((()=>{const e=document.createElement("textarea");e.value=t,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),this.showNotification("ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿","success")}))}async sendMessage(){if(this.isLoading)return;this.isLoading=!0,this.updateSendButton(),this.disableUserInput(!0);const e=document.getElementById("messageInput"),t=e.value.trim();if(!t&&0===this.attachments.length)return this.showNotification("è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹","error"),this.isLoading=!1,this.updateSendButton(),void this.disableUserInput(!1);if(!this.currentUser&&this.accessControl&&this.accessControl.isPublicDomain){const e=document.getElementById("modelSelector");if("pro"===(e?e.value:"flash"))return this.showNotification("âš ï¸ ä½¿ç”¨Proæ¨¡å‹éœ€è¦ç™»å½•ï¼Œè¯·å…ˆç™»å½•è´¦å·ï¼","warning"),this.isLoading=!1,this.updateSendButton(),this.disableUserInput(!1),void setTimeout((()=>{this.showLoginPage()}),2e3);const t=this.accessControl.canSendMessage();if(!t.allowed)return this.showNotification(`âš ï¸ ${t.message}`,"warning",5e3),this.isLoading=!1,this.updateSendButton(),this.disableUserInput(!1),void setTimeout((()=>{this.showLoginPage()}),2e3);this.accessControl.incrementCount()}if(this.attachments.length>0){let e=0;const t=this.attachments.filter((e=>"images"===e.category||["jpg","jpeg","png","gif","webp"].includes(e.path.split(".").pop().toLowerCase())));for(const s of t)s.size&&(e+=s.size);const s=e/1048576;if(s>10)return this.showNotification(`âŒ å›¾ç‰‡è¿‡å¤§ï¼ˆ${s.toFixed(2)}MBï¼‰ï¼Œè¯·åˆ° https://tool.wawacm.com/pic.html å‹ç¼©åå†ä¸Šä¼ ï¼`,"error",8e3),this.isLoading=!1,this.updateSendButton(),void this.disableUserInput(!1);s>5&&this.showNotification(`âš ï¸ å›¾ç‰‡è¾ƒå¤§ï¼ˆ${s.toFixed(2)}MBï¼‰ï¼Œå¯èƒ½ä¼šé€ æˆä¸Šä¼ ç¼“æ…¢`,"warning",5e3)}if(!this.currentSession&&(await this.createNewSession(),!this.currentSession))return this.isLoading=!1,this.updateSendButton(),void this.disableUserInput(!1);let s=null,i=!1;try{const n=document.getElementById("modelSelect").value;if("wawa-image-1"===n||"wawa-image-2"===n)return await this.generateImage(t),this.isLoading=!1,this.updateSendButton(),void this.disableUserInput(!1);const o={role:"user",content:t,attachments:this.attachments.length>0?[...this.attachments]:void 0,created_at:(new Date).toISOString()};this.addMessageToUI(o),!this.currentUser&&"undefined"!=typeof anonymousStorage&&this.currentSession&&anonymousStorage.addMessage(this.currentSession.id,o),s=this.addThinkingMessage();const a=[...this.attachments];e.value="",this.attachments=[],this.updateAttachmentPreview(),this.scrollToBottom();const c=document.getElementById("searchToggle"),r=c&&c.checked&&!this.searchAutoEnabled,l=r;let d;if(r)d=await this.sendMessageStream(this.currentSession.id,t,"wawa-ai-pro",a,!0,s,l);else if(d=await this.apiCall("/chat/messages",{method:"POST",body:{session_id:this.currentSession.id,message:t,model:n,attachments:a,enable_search:l}}),d.switch_to_stream){if(this.showNotification(d.message||"æ­£åœ¨åˆ‡æ¢åˆ°æ·±åº¦æ€è€ƒæ¨¡å¼...","info"),d.auto_enable_search){const e=document.getElementById("searchToggle"),t=document.getElementById("searchToggleLabel");e&&!e.checked&&(e.checked=!0,t&&t.classList.add("checked"),this.searchAutoEnabled=!0,this.showNotification("ğŸŒ æ™ºèƒ½æ£€æµ‹: å·²è‡ªåŠ¨å¯ç”¨è”ç½‘æœç´¢ï¼Œä¸ºæ‚¨è·å–æœ€æ–°ä¿¡æ¯","success",4e3))}else if(this.searchAutoEnabled){const e=document.getElementById("searchToggle"),t=document.getElementById("searchToggleLabel");e&&e.checked&&(e.checked=!1,t&&t.classList.remove("checked")),this.searchAutoEnabled=!1}d=await this.sendMessageStream(this.currentSession.id,t,d.target_model,a,d.enable_thinking,s,d.auto_enable_search||!1)}else if(this.searchAutoEnabled){const e=document.getElementById("searchToggle"),t=document.getElementById("searchToggleLabel");e&&e.checked&&(e.checked=!1,t&&t.classList.remove("checked")),this.searchAutoEnabled=!1}if(this.removeThinkingMessage(s),d.route_to_image&&d.is_image_generation){const e=d.target_model;return this.showNotification("ğŸ¨ æ™ºèƒ½è·¯ç”±: æ£€æµ‹åˆ°å›¾ç‰‡ç”Ÿæˆéœ€æ±‚ï¼Œæ­£åœ¨ç”Ÿæˆ...","info"),s&&(this.removeThinkingMessage(s),s=null),await this.generateImage(t,e,!0,a),this.isLoading=!1,this.updateSendButton(),void this.disableUserInput(!1)}if(d.success){if(i=!0,d.is_auto_routed&&d.route_info){const e=d.route_info.score||"?";if(this.currentUser&&this.currentUser.is_admin){const t=d.routed_model||d.model;this.showNotification(`ğŸ¤– æ™ºèƒ½è·¯ç”±: è¯„åˆ†${e}åˆ†ï¼Œä½¿ç”¨${t}`,"info",3e3)}}const e={role:"assistant",content:d.content,created_at:(new Date).toISOString(),thinking_content:d.thinking_content||null,has_thinking:d.has_thinking||d.show_thinking||!1,is_proxy:d.is_proxy||!1};if(this.addMessageToUI(e),!this.currentUser&&"undefined"!=typeof anonymousStorage&&this.currentSession&&anonymousStorage.addMessage(this.currentSession.id,e),!this.currentUser&&this.accessControl&&this.accessControl.isPublicDomain){const e=this.accessControl.anonymousLimit-this.accessControl.anonymousCount;0===e?(this.showNotification("âš ï¸ æ‚¨ä»Šæ—¥çš„å…è´¹å¯¹è¯æ¬¡æ•°å·²ç”¨å®Œï¼Œè¯·ç™»å½•åç»§ç»­ä½¿ç”¨ï¼","warning",6e3),setTimeout((()=>{this.showLoginPage()}),3e3)):e<=2&&this.showNotification(`âš ï¸ ä»Šæ—¥è¿˜å‰© ${e} æ¬¡å…è´¹å¯¹è¯æœºä¼š`,"info",5e3)}this.scrollToBottom();let t=100;if(this.isMobile){const e=window.innerHeight;if(e>=900)return;if(e>=800)return;t=e>=700?2e3:1500}if(setTimeout((()=>{this.isMobile?this.updateSessionListOnly():this.loadSessions()}),t),d.context_warning){const e=(d.estimated_tokens||0).toLocaleString();this.showNotification(`âš ï¸ ä¸Šä¸‹æ–‡è¾ƒé•¿ï¼ˆçº¦${e} tokensï¼‰ï¼Œå»ºè®®å¼€å¯æ–°å¯¹è¯ä»¥è·å¾—æ›´å¥½çš„å›å¤è´¨é‡ã€‚`,"warning")}}else if(d.context_too_long){const e=d.estimated_tokens||0,t=d.limit||0,s=e.toLocaleString(),i=t.toLocaleString();this.showNotification(`âŒ ${d.error}\nå½“å‰: ${s} tokens\né™åˆ¶: ${i} tokens\n\nç‚¹å‡»å·¦ä¸Šè§’"+"å·åˆ›å»ºæ–°å¯¹è¯`,"error")}else d.is_thinking?this.showNotification("â³ "+d.error,"warning"):this.showNotification(d.error,"error")}catch(e){this.showNotification(e.message,"error"),e.message.includes("åˆ·æ–°é¡µé¢æŸ¥çœ‹")&&setTimeout((async()=>{try{await this.loadMessages(this.currentSession.id),this.showNotification("âœ… æ¶ˆæ¯å·²è‡ªåŠ¨åŠ è½½","success",2e3)}catch(e){}}),1500)}finally{s&&this.removeThinkingMessage(s),!i&&!this.currentUser&&this.accessControl&&this.accessControl.isPublicDomain&&this.accessControl.decrementCount(),this.isLoading=!1,this.updateSendButton(),this.disableUserInput(!1)}}async sendMessageStream(e,t,s,i,n,o,a=!1){return new Promise(((c,r)=>{const l=document.getElementById("chatMessages");let d=null,h="",m="",u=!0;const g=document.getElementById(o);if(g){const e=g.querySelector(".thinking-text");e&&(e.textContent=a?"æ­£åœ¨è”ç½‘æœç´¢ä¸­...":"æ­£åœ¨æ·±åº¦æ€è€ƒä¸­...")}fetch("/api/chat-stream.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:e,message:t,model:s,attachments:i,enable_thinking:n,enable_search:a}),credentials:"include"}).then((e=>{const t=e.body.getReader(),s=new TextDecoder;(async()=>{for(;;){const{done:e,value:i}=await t.read();if(e)break;const n=s.decode(i,{stream:!0}).split("\n");for(const e of n){if(!e.startsWith("data: "))continue;const t=e.slice(6);if("[DONE]"!==t)try{const e=JSON.parse(t);if(e.error)return void c({success:!1,error:e.error});if("thinking"===e.type&&e.thinking&&(h+=e.thinking,g)){const e=g.querySelector(".thinking-text");if(e){const t=h.length>200?"..."+h.slice(-200):h;e.textContent=t,this.scrollToBottom()}}if("content"===e.type&&e.content){if(u&&(u=!1,this.removeThinkingMessage(o),d=document.createElement("div"),d.className="message assistant",d.innerHTML='\n                                            <div class="message-avatar"><i class="fas fa-robot"></i></div>\n                                            <div class="message-content">\n                                                <div class="message-text streaming-text"></div>\n                                            </div>\n                                        ',l.appendChild(d)),m+=e.content,d){const e=d.querySelector(".streaming-text");e&&(e.innerHTML=this.formatMessage(m))}this.scrollToBottom()}if(e.done)return d&&d.remove(),void c({success:!0,content:e.full_content||m,thinking_content:e.full_thinking||h,has_thinking:!!h,is_proxy:!0,tokens:e.tokens,response_time:e.response_time})}catch(e){}}}c({success:!0,content:m,thinking_content:h,has_thinking:!!h,is_proxy:!0})})().catch(r)})).catch(r)}))}updateSendButton(){const e=document.getElementById("sendBtn"),t=document.getElementById("messageInput").value.trim()||this.attachments.length>0;e.disabled=this.isLoading||!t,this.isLoading?e.innerHTML='<div class="loading"></div>':e.innerHTML='<i class="fas fa-paper-plane"></i>'}disableUserInput(e,t=!1){const s=document.getElementById("messageInput"),i=document.getElementById("sendBtn"),n=document.getElementById("attachBtn");e?(s.disabled=!0,s.placeholder=t?"å›¾ç‰‡æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨åå›æ¥æŸ¥çœ‹ï¼":"æ¨¡å‹æ­£åœ¨æ€è€ƒä¸­ï¼Œè¯·ç¨ç­‰...",i.disabled=!0,n.disabled=!0,s.style.pointerEvents="none"):(s.disabled=!1,s.placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯... (æ”¯æŒ Ctrl+V ç²˜è´´å›¾ç‰‡)",i.disabled=!1,n.disabled=!1,s.style.pointerEvents="auto",setTimeout((()=>{s.focus()}),100))}addThinkingMessage(e=!1){const t=document.getElementById("chatMessages"),s=document.createElement("div");s.className="message assistant thinking-message";const i="thinking-"+Date.now();let n;s.id=i;let o=!1;"string"==typeof e?(n=e,o=e.includes("å›¾ç‰‡")):(o=e,n=o?"å›¾ç‰‡æ­£åœ¨ç”Ÿæˆä¸­...":"æ­£åœ¨æ€è€ƒ..."),s.innerHTML=`\n        <div class="message-avatar"><i class="fas fa-robot"></i></div>\n        <div class="message-content">\n            <div class="message-bubble">\n                <div class="message-text">\n                    <div class="thinking-animation">\n                        <span class="thinking-text">${n}</span>\n                        <span class="thinking-dots">\n                            <span class="dot">.</span>\n                            <span class="dot">.</span>\n                            <span class="dot">.</span>\n                        </span>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `,t.appendChild(s),this.scrollToBottom();const a=s.querySelector(".thinking-text");let c,r,l;return o?(c=setTimeout((()=>{document.getElementById(i)&&(a.textContent="å›¾ç‰‡ç”Ÿæˆéœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·ç¨åå›æ¥æŸ¥çœ‹...",this.scrollToBottom())}),15e3),r=setTimeout((()=>{document.getElementById(i)&&(a.textContent="å›¾ç‰‡ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...",this.scrollToBottom())}),3e4),l=setTimeout((()=>{document.getElementById(i)&&(a.textContent="å›¾ç‰‡ç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼Œæ‚¨å¯ä»¥ç¨ååˆ·æ–°æŸ¥çœ‹ç»“æœ",a.style.color="#f59e0b",this.scrollToBottom())}),6e4)):(c=setTimeout((()=>{document.getElementById(i)&&(a.textContent="æˆ‘è¿˜åœ¨æ€è€ƒä¸­ï¼Œè¯·ç¨ç­‰...",this.scrollToBottom())}),2e4),r=setTimeout((()=>{document.getElementById(i)&&(a.textContent="å½“å‰é—®é¢˜æœ‰ç‚¹å¤æ‚ï¼Œè¯·ç¨ç­‰...",this.scrollToBottom())}),3e4),l=setTimeout((()=>{document.getElementById(i)&&(a.textContent="ç”±äºç½‘ç»œé—®é¢˜ï¼Œæˆ‘å¡äº†ï¼Œè¯·åˆ·æ–°å¹¶ä¸”å°è¯•é‡æ–°æé—®ï¼ŒæŠ±æ­‰!",a.style.color="#ef4444",this.scrollToBottom())}),6e4)),s.thinkingTimers=[c,r,l],i}removeThinkingMessage(e=null){if(e){const t=document.getElementById(e);t&&(t.thinkingTimers&&t.thinkingTimers.forEach((e=>clearTimeout(e))),t.remove())}else{document.querySelectorAll(".thinking-message").forEach((e=>{e.thinkingTimers&&e.thinkingTimers.forEach((e=>clearTimeout(e))),e.remove()}))}}initSearchButton(){const e=document.getElementById("searchToggle"),t=document.getElementById("searchToggleLabel");e&&t&&(e.checked=!1,t.classList.remove("checked"))}handleSearchToggle(e){const t=e.target,s=t.closest(".search-toggle-label");this.searchAutoEnabled=!1,t.checked?(s.classList.add("checked"),this.showNotification("ğŸŒ å·²å¯ç”¨è”ç½‘æœç´¢ï¼Œå°†ä½¿ç”¨è¶…çº§æ¨¡å‹å®æ—¶æœç´¢ç½‘ç»œ","success",3e3)):(s.classList.remove("checked"),this.showNotification("âš¡ å·²å…³é—­è”ç½‘æœç´¢ï¼Œä½¿ç”¨å¸¸è§„æ¨¡å¼","info",2e3))}toggleThinkingContent(e){const t=document.getElementById(e);if(!t)return;const s=t.querySelector(".thinking-body"),i=t.querySelector(".thinking-toggle");"none"===s.style.display?(s.style.display="block",i.classList.remove("fa-chevron-down"),i.classList.add("fa-chevron-up"),t.classList.add("expanded")):(s.style.display="none",i.classList.remove("fa-chevron-up"),i.classList.add("fa-chevron-down"),t.classList.remove("expanded"))}handleModelChange(e){const t=e.target.value;!this.currentUser&&this.accessControl&&this.accessControl.isPublicDomain&&"pro"===t&&(this.showNotification("âš ï¸ ä½¿ç”¨Proæ¨¡å‹éœ€è¦ç™»å½•ï¼Œè¯·å…ˆç™»å½•è´¦å·ï¼","warning"),setTimeout((()=>{e.target.value="flash",this.showLoginPage()}),2e3))}async compressImageIfNeeded(e){try{const t=e.name||"image",s=t.split(".").pop().toLowerCase();if(!(e.type&&e.type.startsWith("image/")||["jpg","jpeg","png","gif","webp","heic","heif"].includes(s))||e.size<=2097152)return e;if((e.type&&(e.type.includes("heic")||e.type.includes("heif"))||"heic"===s||"heif"===s)&&window.heic2any)try{const s=await window.heic2any({blob:e,toType:"image/jpeg",quality:.7}),i=Array.isArray(s)?s[0]:s;return new File([i],t.replace(/\.[^\.]+$/,".jpg"),{type:"image/jpeg"})}catch(e){}const i=await new Promise(((t,s)=>{const i=new FileReader;i.onload=()=>t(i.result),i.onerror=s,i.readAsDataURL(e)})),n=await new Promise(((e,t)=>{const s=new Image;s.onload=()=>e(s),s.onerror=t,s.src=i})),o=document.createElement("canvas"),a=n.naturalWidth||n.width,c=n.naturalHeight||n.height;o.width=a,o.height=c;const r=o.getContext("2d");("image/png"===e.type||"png"===s)&&(r.fillStyle="#ffffff",r.fillRect(0,0,a,c)),r.drawImage(n,0,0,a,c);const l=await new Promise((e=>o.toBlob(e,"image/jpeg",.7)));if(!l)return e;const d=t.replace(/\.[^\.]+$/,".jpg");return new File([l],d,{type:"image/jpeg"})}catch(t){return e}}setUploadProgress(e){const t=document.getElementById("sendBtn");if(!t)return;if(null==e)return t.classList.remove("uploading"),void(t.innerHTML='<i class="fas fa-paper-plane"></i>');t.classList.add("uploading");const s=Math.max(0,Math.min(100,Math.round(e)));t.innerHTML=`<span class="progress-text">${s}%</span>`}async uploadToS4(e,t="images"){const s={filename:e.name||"upload.jpg",content_type:e.type||"application/octet-stream",category:t},i=await this.apiCall("/s4/presign",{method:"POST",body:s});if(!i||!i.success)throw new Error(i&&i.error||"S4 é¢„ç­¾åå¤±è´¥");const n=new FormData;Object.entries(i.fields).forEach((([e,t])=>n.append(e,t))),n.append("file",e);const o=await new Promise(((e,t)=>{try{const s=new XMLHttpRequest;s.open("POST",i.url,!0),s.onload=()=>{e({status:s.status,ok:201===s.status||s.status>=200&&s.status<300,text:s.responseText})},s.onerror=()=>t(new Error("S4 ç½‘ç»œé”™è¯¯")),s.upload.onprogress=e=>{if(e.lengthComputable){const t=e.loaded/e.total*100;this.setUploadProgress(t)}},s.send(n)}catch(e){t(e)}}));if(this.setUploadProgress(null),!o.ok)throw new Error("S4 ä¸Šä¼ å¤±è´¥");const a=i.public_url_cdn||i.public_url_hosted||i.public_url;return{name:e.name,path:null,url:a,size:e.size,type:e.type||"image/jpeg",category:t,source:"s4",key:i.key,bucket:i.bucket}}async handleFileUpload(e){const t=Array.from(e.target.files);for(const e of t)try{const t=10485760;if(e.size>t){this.showNotification(`æ–‡ä»¶ "${e.name}" è¿‡å¤§ï¼Œæœ€å¤§æ”¯æŒ 10MB`,"error");continue}const s=["jpg","jpeg","png","gif","webp","heic","heif","pdf","doc","docx","ppt","pptx","txt","rtf","mp4","avi","mov"],i=e.name.split(".").pop().toLowerCase();if(!s.includes(i)){this.showNotification(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${i}`,"error");continue}const n=e.type&&e.type.startsWith("image/")||["jpg","jpeg","png","gif","webp","heic","heif"].includes(i)?await this.compressImageIfNeeded(e):e;try{const e=["jpg","jpeg","png","gif","webp","heic","heif"],t=["mp4","avi","mov","wmv","flv"],s=n.type&&n.type.startsWith("image/")||e.includes(i)?"images":t.includes(i)?"videos":"documents",o=await this.uploadToS4(n,s);this.attachments.push(o),this.updateAttachmentPreview(),this.showNotification("âœ… æ–‡ä»¶å·²ä¸Šä¼ åˆ° OSS","success")}catch(e){const t=new FormData;t.append("file",n);try{const e=await fetch("api/upload",{method:"POST",body:t}),s=await e.json();if(s.success){const e={...s.file,source:"local"};this.attachments.push(e),this.updateAttachmentPreview(),this.showNotification("âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ","success")}else this.showNotification(`âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${s.message||s.error}`,"error")}catch(e){this.showNotification(`âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${e.message}`,"error")}}}catch(e){this.showNotification(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${e.message}`,"error")}e.target.value=""}updateAttachmentPreview(){const e=document.getElementById("attachmentPreview");if(0===this.attachments.length)return e.style.display="none",void(e.innerHTML="");e.style.display="flex",e.innerHTML="",this.attachments.forEach(((t,s)=>{const i=document.createElement("div"),n="images"===t.category;i.className=n?"attachment-item image-attachment-preview":"attachment-item";const o=this.getFileIcon(t.category);i.innerHTML=n?`\n                    <i class="${o}"></i>\n                    <span class="attachment-name" onclick="app.showImagePreview('${t.url}', '${t.name}')" style="cursor: pointer;">${t.name}</span>\n                    <i class="fas fa-eye preview-icon-small" onclick="app.showImagePreview('${t.url}', '${t.name}')" style="cursor: pointer;" title="é¢„è§ˆå›¾ç‰‡"></i>\n                    <button class="attachment-remove" onclick="app.removeAttachment(${s})">&times;</button>\n                `:`\n                    <i class="${o}"></i>\n                    <span>${t.name}</span>\n                    <button class="attachment-remove" onclick="app.removeAttachment(${s})">&times;</button>\n                `,e.appendChild(i)})),this.updateSendButton()}async removeAttachment(e){const t=this.attachments[e];if(this.accessControl&&this.accessControl.isPublicDomain&&!this.accessControl.isApiDomain&&!this.currentUser&&t&&"s4"===t.source&&t.key)return this.showNotification("âš ï¸ åŒ¿åç”¨æˆ·ä¸æ”¯æŒåˆ é™¤å›¾ç‰‡ï¼Œè¯·ç™»å½•åæ“ä½œ","warning"),this.attachments.splice(e,1),this.updateAttachmentPreview(),void this.updateSendButton();if(t&&"s4"===t.source&&t.key){try{const e=await this.apiCall("/s4/delete",{method:"POST",body:{key:t.key}});if(e&&e.success)this.showNotification("âœ… å·²ä»OSSåˆ é™¤è¯¥æ–‡ä»¶","success");else{const t=e.error||e.message||"æœªçŸ¥é”™è¯¯";t.includes("ç™»å½•å·²è¿‡æœŸ")||t.includes("åŒ¿åç”¨æˆ·")||!this.currentUser?this.showNotification("âš ï¸ OSSåˆ é™¤å¤±è´¥ï¼šç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•ã€‚","warning"):this.showNotification(`âš ï¸ OSSåˆ é™¤å¤±è´¥ï¼š${t}`,"warning")}}catch(e){e.message&&e.message.includes("ç™»å½•å·²è¿‡æœŸ")||!this.currentUser?this.showNotification("âš ï¸ OSSåˆ é™¤å¤±è´¥ï¼šç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•ã€‚","warning"):this.showNotification(`âŒ OSSåˆ é™¤å¤±è´¥ï¼š${e.message}`,"error")}this.attachments.splice(e,1),this.updateAttachmentPreview(),this.updateSendButton()}else this.attachments.splice(e,1),this.updateAttachmentPreview(),this.updateSendButton()}getFileIcon(e){return{images:"fas fa-image",videos:"fas fa-video",documents:"fas fa-file-alt"}[e]||"fas fa-file"}async searchSessions(e){if(e.trim())try{const t=await this.apiCall(`/chat/search?keyword=${encodeURIComponent(e)}`);if(t.success){const e=t.messages.reduce(((e,t)=>(e.find((e=>e.id===t.session_id))||e.push({id:t.session_id,title:t.session_title,last_message:t.content,updated_at:t.created_at}),e)),[]);this.renderSessions(e)}}catch(e){this.showNotification("æœç´¢å¤±è´¥","error")}else this.loadSessions()}formatLastLoginTime(e){if(!e)return"é¦–æ¬¡ç™»å½•";try{const t=new Date(e),s=new Date-t;if(isNaN(t.getTime())||s<0)return"é¦–æ¬¡ç™»å½•";const i=Math.floor(s/864e5),n=Math.floor(s/36e5),o=Math.floor(s/6e4);return i>0?`${i}å¤©å‰ (${t.toLocaleString("zh-CN")})`:n>0?`${n}å°æ—¶å‰ (${t.toLocaleString("zh-CN")})`:o>0?`${o}åˆ†é’Ÿå‰ (${t.toLocaleString("zh-CN")})`:"åˆšåˆš (æœ¬æ¬¡ç™»å½•)"}catch(e){return"é¦–æ¬¡ç™»å½•"}}formatTime(e){let t;if("string"==typeof e){if(t=new Date(e),isNaN(t.getTime())){const s=parseInt(e);if(isNaN(s))return"æ—¶é—´æ— æ•ˆ";t=new Date(s<1e10?1e3*s:s)}}else{if("number"!=typeof e)return"æ—¶é—´æ— æ•ˆ";t=new Date(e<1e10?1e3*e:e)}if(isNaN(t.getTime()))return"æ—¶é—´æ— æ•ˆ";const s=new Date-t;if(s<0){if(Math.abs(s)<36e5){const e=Math.abs(s);if(e<6e4)return"åˆšåˆš";if(e<36e5)return`${Math.floor(e/6e4)}åˆ†é’Ÿå‰`}return t.toLocaleString("zh-CN")}return s<6e4?"åˆšåˆš":s<36e5?`${Math.floor(s/6e4)}åˆ†é’Ÿå‰`:s<864e5?`${Math.floor(s/36e5)}å°æ—¶å‰`:t.toLocaleDateString("zh-CN",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}scrollToBottom(){const e=document.getElementById("chatMessages");e.scrollTop=e.scrollHeight}autoResizeTextarea(){document.getElementById("messageInput").addEventListener("input",(function(){this.style.height="auto",this.style.height=Math.min(this.scrollHeight,120)+"px"}))}initImagePreview(){document.addEventListener("click",(e=>{const t=e.target;"IMG"===t.tagName&&t.closest(".generated-image")&&(e.preventDefault(),this.showImagePreview(t.src,t.alt||"AIç”Ÿæˆå›¾ç‰‡"))}))}showImagePreview(e,t){const s=document.createElement("div");s.className="image-preview-modal",s.innerHTML=`\n            <div class="image-preview-overlay"></div>\n            <div class="image-preview-container">\n                <button class="image-preview-close" title="å…³é—­">\n                    <i class="fas fa-times"></i>\n                </button>\n                <img src="${e}" alt="${t}" />\n                <div class="image-preview-actions">\n                    <button onclick="window.open('${e}', '_blank')" title="åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€">\n                        <i class="fas fa-external-link-alt"></i> æ–°çª—å£æ‰“å¼€\n                    </button>\n                    <button onclick="app.downloadImage('${e}', '${t}')" title="ä¸‹è½½å›¾ç‰‡">\n                        <i class="fas fa-download"></i> ä¸‹è½½å›¾ç‰‡\n                    </button>\n                </div>\n            </div>\n        `,document.body.appendChild(s),s.querySelector(".image-preview-overlay").addEventListener("click",(()=>{s.remove()})),s.querySelector(".image-preview-close").addEventListener("click",(()=>{s.remove()}));const i=e=>{"Escape"===e.key&&(s.remove(),document.removeEventListener("keydown",i))};document.addEventListener("keydown",i)}downloadImage(e,t){const s=document.createElement("a");s.href=e,s.download=t||"ai-generated-image.png",s.target="_blank",e.startsWith("http")&&!e.includes(window.location.hostname)?fetch(e).then((e=>e.blob())).then((e=>{const t=URL.createObjectURL(e);s.href=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(t),this.showNotification("å›¾ç‰‡ä¸‹è½½å·²å¼€å§‹","success")})).catch((t=>{window.open(e,"_blank"),this.showNotification("è¯·åœ¨æ–°çª—å£ä¸­å³é”®ä¿å­˜å›¾ç‰‡","info")})):(document.body.appendChild(s),s.click(),document.body.removeChild(s),this.showNotification("å›¾ç‰‡ä¸‹è½½å·²å¼€å§‹","success"))}initPasteAndDrop(){const e=document.getElementById("chatMessages"),t=document.getElementById("messageInput"),s=document.querySelector(".input-wrapper"),i=document.querySelector(".chat-input-container");t.addEventListener("paste",(e=>this.handlePaste(e))),e.addEventListener("paste",(e=>this.handlePaste(e)));[e,i,s].forEach((e=>{["dragenter","dragover","dragleave","drop"].forEach((t=>{e.addEventListener(t,(e=>{e.preventDefault(),e.stopPropagation()}),!1)}));let t=0;e.addEventListener("dragenter",(s=>{t++,e.classList.add("drag-over")})),e.addEventListener("dragover",(t=>{e.classList.add("drag-over")})),e.addEventListener("dragleave",(s=>{t--,t<=0&&(t=0,e.classList.remove("drag-over"))})),e.addEventListener("drop",(s=>{t=0,e.classList.remove("drag-over"),document.querySelectorAll(".drag-over").forEach((e=>e.classList.remove("drag-over"))),this.handleDrop(s)}))})),window.addEventListener("dragover",(e=>{e.preventDefault()}),!1),window.addEventListener("drop",(e=>{e.preventDefault()}),!1)}handlePaste(e){const t=e.clipboardData?.items;if(!t)return;let s=!1;for(let i=0;i<t.length;i++){const n=t[i];if(-1!==n.type.indexOf("image")){s=!0,e.preventDefault();const t=n.getAsFile();t&&this.uploadPastedImage(t);break}}s&&this.showNotification("ğŸ“‹ æ­£åœ¨ä¸Šä¼ ç²˜è´´çš„å›¾ç‰‡...","info")}handleDrop(e){const t=e.dataTransfer?.files;t&&0!==t.length&&(this.showNotification(`ğŸ“¤ æ­£åœ¨ä¸Šä¼  ${t.length} ä¸ªæ–‡ä»¶...`,"info"),Array.from(t).forEach((e=>{this.uploadDroppedFile(e)})))}async uploadPastedImage(e){const t=(new Date).getTime(),s=new File([e],`pasted-image-${t}.png`,{type:e.type});if(s.size>10485760)return void this.showNotification("âŒ å›¾ç‰‡è¿‡å¤§ï¼Œæœ€å¤§æ”¯æŒ 10MB","error");const i=await this.compressImageIfNeeded(s);try{const e=await this.uploadToS4(i,"images");this.attachments.push(e),this.updateAttachmentPreview(),this.showNotification("âœ… å›¾ç‰‡å·²ä¸Šä¼ åˆ° OSS","success")}catch(e){const t=new FormData;t.append("file",i);try{const e=await fetch("api/upload",{method:"POST",body:t}),s=await e.json();if(s.success){const e={...s.file,source:"local"};this.attachments.push(e),this.updateAttachmentPreview(),this.showNotification("âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ","success")}else this.showNotification(`âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${s.message||s.error}`,"error")}catch(e){this.showNotification(`âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${e.message}`,"error")}}}async uploadDroppedFile(e){if(e.size>10485760)return void this.showNotification(`âŒ æ–‡ä»¶ "${e.name}" è¿‡å¤§ï¼Œæœ€å¤§æ”¯æŒ 10MB`,"error");const t=e.name.split(".").pop().toLowerCase();if(!["jpg","jpeg","png","gif","webp","heic","heif","pdf","doc","docx","ppt","pptx","txt","rtf","mp4","avi","mov"].includes(t))return void this.showNotification(`âŒ ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${t}`,"error");const s=e.type&&e.type.startsWith("image/")||["jpg","jpeg","png","gif","webp","heic","heif"].includes(t)?await this.compressImageIfNeeded(e):e;try{const e=["jpg","jpeg","png","gif","webp","heic","heif"],i=["mp4","avi","mov","wmv","flv"],n=s.type&&s.type.startsWith("image/")||e.includes(t)?"images":i.includes(t)?"videos":"documents",o=await this.uploadToS4(s,n);this.attachments.push(o),this.updateAttachmentPreview(),this.showNotification("âœ… æ–‡ä»¶å·²ä¸Šä¼ åˆ° OSS","success")}catch(e){const t=new FormData;t.append("file",s);try{const e=await fetch("api/upload",{method:"POST",body:t}),s=await e.json();if(s.success){const e={...s.file,source:"local"};this.attachments.push(e),this.updateAttachmentPreview(),this.showNotification("âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ","success")}else this.showNotification(`âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${s.message||s.error}`,"error")}catch(e){this.showNotification(`âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${e.message}`,"error")}}}showModal(e){document.getElementById("modalBody").innerHTML=e,document.getElementById("modal").style.display="block"}closeModal(){document.getElementById("modal").style.display="none"}showImagePreview(e,t){let s=document.getElementById("imagePreviewModal");s||(s=document.createElement("div"),s.id="imagePreviewModal",s.className="image-preview-modal",s.innerHTML='\n                <div class="image-preview-overlay" onclick="app.closeImagePreview()"></div>\n                <div class="image-preview-container">\n                    <button class="image-preview-close" onclick="app.closeImagePreview()">\n                        <i class="fas fa-times"></i>\n                    </button>\n                    <div class="image-preview-content">\n                        <img id="previewImage" src="" alt="">\n                        <div class="image-preview-info">\n                            <i class="fas fa-image"></i>\n                            <span id="previewImageName"></span>\n                        </div>\n                    </div>\n                    <div class="image-preview-actions">\n                        <a id="downloadImageBtn" href="" download="" class="btn-icon" title="ä¸‹è½½å›¾ç‰‡">\n                            <i class="fas fa-download"></i>\n                        </a>\n                    </div>\n                </div>\n            ',document.body.appendChild(s),document.addEventListener("keydown",(e=>{"Escape"===e.key&&s.classList.contains("active")&&this.closeImagePreview()})));const i=document.getElementById("previewImage"),n=document.getElementById("previewImageName"),o=document.getElementById("downloadImageBtn");i.src=e,i.alt=t,n.textContent=t,o.href=e,o.download=t,s.classList.add("active"),document.body.style.overflow="hidden",setTimeout((()=>{s.classList.add("loaded")}),10)}closeImagePreview(){const e=document.getElementById("imagePreviewModal");e&&(e.classList.remove("loaded"),setTimeout((()=>{e.classList.remove("active"),document.body.style.overflow=""}),300))}async deleteSession(e){if(!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚"))return;const t=document.querySelector(`[data-session-id="${e}"]`);if(t){t.style.opacity="0.5",t.style.pointerEvents="none";const e=t.querySelector(".session-item-actions");e&&(e.innerHTML='<div class="session-loading"><i class="fas fa-spinner fa-spin"></i></div>')}this.currentSession&&this.currentSession.id==e&&(this.currentSession=null,document.getElementById("currentSessionTitle").textContent="é€‰æ‹©æˆ–åˆ›å»ºæ–°å¯¹è¯",document.getElementById("editTitleBtn").style.display="none",document.getElementById("chatMessages").innerHTML='\n                <div class="welcome-message">\n                    <div class="welcome-icon">\n                        <i class="fas fa-robot"></i>\n                    </div>\n                    <h3>æ¬¢è¿ä½¿ç”¨ WawaCloud AI èŠå¤©åŠ©æ‰‹</h3>\n                    <p>æˆ‘æ˜¯å¨ƒå¨ƒå›¢é˜Ÿæ——ä¸‹åŸºäºgoogleGeminiè®­ç»ƒå¼€å‘çš„AiåŠ©æ‰‹</p>\n                    <p>æˆ‘å¯ä»¥å¸®åŠ©æ‚¨è§£ç­”é—®é¢˜ã€åˆ†æå›¾ç‰‡ã€å¤„ç†æ–‡æ¡£ç­‰ã€‚å¼€å§‹æ–°å¯¹è¯å§ï¼</p>\n                    <div class="feature-list">\n                        <div class="feature-item">\n                            <i class="fas fa-image"></i>\n                            <span>å›¾ç‰‡åˆ†æ</span>\n                        </div>\n                        <div class="feature-item">\n                            <i class="fas fa-search"></i>\n                            <span>ç½‘ç»œæœç´¢</span>\n                        </div>\n                        <div class="feature-item">\n                            <i class="fas fa-brain"></i>\n                            <span>æ™ºèƒ½æ¨ç†</span>\n                        </div>\n                        <div class="feature-item">\n                            <i class="fas fa-file-alt"></i>\n                            <span>æ–‡æ¡£å¤„ç†</span>\n                        </div>\n                    </div>\n                </div>\n            ');try{const s=await this.apiCall("/chat/sessions",{method:"DELETE",body:{session_id:e}});if(s.success)this.showNotification("å¯¹è¯åˆ é™¤æˆåŠŸ","success"),t&&(t.style.transform="translateX(-100%)",setTimeout((()=>{t.remove()}),300));else{if(t){t.style.opacity="1",t.style.pointerEvents="auto";const s=t.querySelector(".session-item-actions");s&&(s.innerHTML=`\n                            <button class="session-delete-btn" onclick="event.stopPropagation(); app.deleteSession(${e});" title="åˆ é™¤">\n                                <i class="fas fa-trash"></i>\n                            </button>\n                        `)}this.showNotification(s.message||"åˆ é™¤å¤±è´¥","error")}}catch(s){if(t){t.style.opacity="1",t.style.pointerEvents="auto";const s=t.querySelector(".session-item-actions");s&&(s.innerHTML=`\n                        <button class="session-delete-btn" onclick="event.stopPropagation(); app.deleteSession(${e});" title="åˆ é™¤">\n                            <i class="fas fa-trash"></i>\n                        </button>\n                    `)}this.showNotification("åˆ é™¤å¯¹è¯å¤±è´¥","error")}}initMobileInputAdaptation(){const e=document.getElementById("messageInput"),t=document.querySelector(".chat-input-container"),s=document.getElementById("chatMessages");if(!e||!t||!s)return;if(!(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768))return;let i=!1,n=window.innerHeight,o=null,a=null,c=!1;const r=()=>{const e=window.innerHeight;return e>=900?{heightThreshold:200,adaptDelay:150,blurDelay:500,focusDelay:400}:e>=700?{heightThreshold:150,adaptDelay:100,blurDelay:300,focusDelay:300}:{heightThreshold:100,adaptDelay:50,blurDelay:200,focusDelay:200}},l=()=>{o&&clearTimeout(o);const e=r();o=setTimeout((()=>{const t=window.innerHeight;n-t>e.heightThreshold?i||(i=!0,this.adaptToKeyboard(!0)):i&&(i=!1,this.adaptToKeyboard(!1))}),e.adaptDelay)};e.addEventListener("focus",(()=>{const e=r();setTimeout((()=>{l()}),e.focusDelay)})),e.addEventListener("blur",(()=>{a&&clearTimeout(a);const e=r();a=setTimeout((()=>{c?setTimeout((()=>{i=!1,this.adaptToKeyboard(!1)}),1e3):(i=!1,this.adaptToKeyboard(!1))}),e.blurDelay)}));const d=document.getElementById("sendBtn");d&&d.addEventListener("click",(()=>{c=!0,setTimeout((()=>{c=!1}),2e3)})),e.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(c=!0,setTimeout((()=>{c=!1}),2e3))})),window.addEventListener("resize",l),window.visualViewport&&window.visualViewport.addEventListener("resize",l)}adaptToKeyboard(e){const t=document.querySelector(".chat-input-container"),s=document.getElementById("chatMessages"),i=document.querySelector(".main-chat"),n=document.querySelector(".chat-header-new");if(!t||!s||!i)return;const o=window.innerHeight>=900;if(e){t.style.position="fixed",t.style.bottom="0",t.style.left="0",t.style.right="0",t.style.zIndex="1000";const e=t.offsetHeight,a=o?60:40;s.style.paddingBottom=`calc(${e+a}px + env(safe-area-inset-bottom))`,i.style.height="100vh",i.style.maxHeight="100vh",i.style.overflow="hidden",n&&(n.style.position="sticky",n.style.top="0",n.style.zIndex="10",n.style.flexShrink="0");setTimeout((()=>{this.scrollToBottom()}),o?200:100)}else{const e=s.scrollTop;t.style.position="",t.style.bottom="",t.style.left="",t.style.right="",t.style.zIndex="",s.style.paddingBottom="",s.style.minHeight="auto",o&&(s.style.transition="none",s.offsetHeight,s.style.transition=""),i.style.height="",i.style.maxHeight="",i.style.overflow="",n&&(n.style.position="",n.style.top="",n.style.zIndex="",n.style.flexShrink=""),setTimeout((()=>{s.scrollTop=e}),50),this.preventPageZoom()}}preventPageZoom(){const e=document.querySelector('meta[name="viewport"]');e&&e.setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"),setTimeout((()=>{document.body.style.zoom="1",document.documentElement.style.zoom="1"}),100)}initLoginInputAdaptation(){const e=document.querySelectorAll("#loginUsername, #loginPassword, #registerUsername, #registerEmail, #registerPassword, #registerConfirmPassword"),t=document.querySelector(".login-container"),s=document.querySelector(".login-box");if(!e.length||!t||!s)return;if(!(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768))return;let i=!1,n=window.innerHeight;const o=()=>{const e=window.innerHeight;n-e>150?i||(i=!0,this.adaptLoginToKeyboard(!0,t,s)):i&&(i=!1,this.adaptLoginToKeyboard(!1,t,s))};e.forEach((e=>{e.addEventListener("focus",(()=>{setTimeout((()=>{o()}),300)})),e.addEventListener("blur",(()=>{i=!1,this.adaptLoginToKeyboard(!1,t,s)}))})),window.addEventListener("resize",o),window.visualViewport&&window.visualViewport.addEventListener("resize",o)}adaptLoginToKeyboard(e,t,s){t&&s&&(e?(t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.right="0",t.style.bottom="0",t.style.height="100vh",t.style.maxHeight="100vh",t.style.overflow="hidden",s.style.maxHeight="calc(100vh - 40px)",s.style.overflowY="auto",s.style.webkitOverflowScrolling="touch",setTimeout((()=>{const e=document.activeElement;e&&"INPUT"===e.tagName&&e.scrollIntoView({behavior:"smooth",block:"center"})}),100)):(t.style.position="",t.style.top="",t.style.left="",t.style.right="",t.style.bottom="",t.style.height="",t.style.maxHeight="",t.style.overflow="",s.style.maxHeight="",s.style.overflowY="",s.style.webkitOverflowScrolling="",this.preventPageZoom()))}async generateImage(e,t=null,s=!1,i=null){if(!this.currentSession&&(await this.createNewSession(),!this.currentSession))return;this.isLoading=!0,this.updateSendButton(),this.disableUserInput(!0,!0);let n=null;const o=i||[...this.attachments];i||(this.attachments=[],this.updateAttachmentPreview());try{if(!s){this.addMessageToUI({role:"user",content:e,attachments:o.length>0?o:void 0,created_at:(new Date).toISOString()});document.getElementById("messageInput").value=""}n=this.addThinkingMessage(!0),this.scrollToBottom();const i=t||document.getElementById("modelSelect").value;let a="/generate-image";if("wawa-image-1"===i&&(a="/kolors"),"wawa-image-2"===i&&(a="/banana"),"wawa-image-2"===i){const t=localStorage.getItem("auth_token"),i={"Content-Type":"application/json"};t&&(i.Authorization=`Bearer ${t}`);const c=new AbortController,r=setTimeout((()=>c.abort()),18e4);try{const t=await fetch("api"+a,{method:"POST",headers:i,body:JSON.stringify({prompt:e,session_id:this.currentSession.id,attachments:o.length>0?o:void 0,skip_user_message:s}),signal:c.signal});if(!t.ok){clearTimeout(r);const e=await t.text();throw new Error(`API Error: ${t.status} ${e}`)}if((t.headers.get("content-type")||"").includes("application/json")){clearTimeout(r);const e=await t.json();if(!1===e.success)return this.removeThinkingMessage(n),e.quota_exceeded?this.showNotification(`âš ï¸ ${e.error}`,"warning"):this.showNotification(`âŒ ${e.error||"å›¾ç‰‡ç”Ÿæˆå¤±è´¥"}`,"error"),this.isLoading=!1,this.updateSendButton(),void this.disableUserInput(!1)}const l=t.body.getReader(),d=new TextDecoder;let h="",m="",u={requireUpload:!1,messageId:null,tempUrl:null,isHttpUrl:!1,prompt:""};const g=document.getElementById(`thinking-${n}`);let p=null;g&&(p=g.querySelector(".message-content"),p&&(p.innerHTML='<div class="thinking-dots">æ­£åœ¨ç”Ÿæˆä¸­</div>'));let f="",y=0;for(;;){const{value:t,done:s}=await l.read();if(s)break;y++;const i=d.decode(t,{stream:!0});m+=i,f+=i;const n=f.split("\n");f=n.pop();for(const t of n){const s=t.trim();if(s.startsWith("data: ")){const t=s.slice(6).trim();if("[DONE]"===t)continue;try{const s=JSON.parse(t);if(s.debug)continue;if(s.require_upload){u.requireUpload=!0,u.messageId=s.message_id,u.tempUrl=s.temp_url,u.isHttpUrl=s.is_http_url,u.prompt=s.prompt||e;continue}const i=s.choices?.[0]?.delta?.content||"";i&&(h+=i,p&&(p.innerHTML.includes("thinking-dots")?p.innerHTML=i:p.innerHTML+=i,this.scrollToBottom()))}catch(e){}}}}clearTimeout(r),this.removeThinkingMessage(n);let w=h.replace(/( \.)+/g,"").trim();!w&&h&&(w=h.replace(/\s\./g,"").trim()),w||(w=h);let v="";const b=w.match(/!\[([^\]]*)\]\(([^)]+)\)/),S=w.match(/https?:\/\/[^\s"'\)]+/),E=w.replace(/\s/g,""),I=w.startsWith("data:image")||E.length>100&&/^[A-Za-z0-9+/=]+$/.test(E);if(b){const t=b[2],s="banana-img-"+Date.now(),i=t.startsWith("http://")||t.startsWith("https://");v+=`\n                        <div class="generated-image">\n                            <img id="${s}" src="${t}" alt="${e}" />\n                            <p class="image-prompt">æç¤ºè¯ï¼š${e}</p>\n                            <p class="image-time">ç”Ÿæˆå®Œæˆ</p>\n                            <p class="upload-status" id="${s}-status" style="color: #888; font-size: 12px;">æ­£åœ¨ä¿å­˜åˆ°äº‘ç«¯...</p>\n                        </div>\n                    `,this.showNotification("å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼æ­£åœ¨ä¿å­˜åˆ°äº‘ç«¯...","success"),this.currentUser&&u.messageId&&setTimeout((()=>{i?this.uploadImageToOSS(t,u.messageId,s,e):t.startsWith("data:image")&&this.uploadBase64ToOSS(t,u.messageId,s,e)}),100)}else if(S){const t=S[0],s="banana-img-"+Date.now();v+=`\n                        <div class="generated-image">\n                            <img id="${s}" src="${t}" alt="${e}" />\n                            <p class="image-prompt">æç¤ºè¯ï¼š${e}</p>\n                            <p class="image-time">ç”Ÿæˆå®Œæˆ</p>\n                            <p class="upload-status" id="${s}-status" style="color: #888; font-size: 12px;">æ­£åœ¨ä¿å­˜åˆ°äº‘ç«¯...</p>\n                        </div>\n                    `,this.showNotification("å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼æ­£åœ¨ä¿å­˜åˆ°äº‘ç«¯...","success"),this.currentUser&&u.messageId&&setTimeout((()=>{this.uploadImageToOSS(t,u.messageId,s,e)}),100)}else if(I){let t=E;t.startsWith("data:image")||(t=`data:image/png;base64,${E}`);const s="banana-img-"+Date.now();v+=`\n                        <div class="generated-image">\n                            <img id="${s}" src="${t}" alt="${e}" />\n                            <p class="image-prompt">æç¤ºè¯ï¼š${e}</p>\n                            <p class="image-time">ç”Ÿæˆå®Œæˆ</p>\n                            <p class="upload-status" id="${s}-status" style="color: #888; font-size: 12px;">æ­£åœ¨ä¿å­˜åˆ°äº‘ç«¯...</p>\n                        </div>\n                    `,this.showNotification("å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼æ­£åœ¨ä¿å­˜åˆ°äº‘ç«¯...","success"),this.currentUser&&u.messageId&&setTimeout((()=>{this.uploadBase64ToOSS(t,u.messageId,s,e)}),100)}else{if(!w)return this.showNotification("å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼šæœªè¿”å›å†…å®¹","error"),this.isLoading=!1,this.updateSendButton(),void this.disableUserInput(!1);w.length>2e3&&!w.includes(" ")?v+=this.formatMessageText(w.substring(0,200)+"\n\n[å†…å®¹è¿‡é•¿ï¼Œç–‘ä¼¼éæ–‡æœ¬æ•°æ®ï¼Œå·²æˆªæ–­...]"):v+=this.formatMessageText(w),this.showNotification("ç”Ÿæˆå®Œæˆ","success")}return this.addMessageToUI({role:"assistant",content:v,created_at:(new Date).toISOString()}),this.scrollToBottom(),setTimeout((()=>{this.isMobile?this.updateSessionListOnly():this.loadSessions()}),1e3),void this.disableUserInput(!1)}catch(e){throw clearTimeout(r),e}}const c=await this.apiCall(a,{method:"POST",body:{prompt:e,session_id:this.currentSession.id,skip_save_user_message:!!t}});if(this.removeThinkingMessage(n),c.success){let t="",s=null;if("wawa-image-1"===i)if(c.data&&c.data.images&&c.data.images.length>0){const i=c.data.images[0].url,n=c.data.timings?c.data.timings.inference:0,o=c.message_id,a=c.require_upload,r="kolors-img-"+Date.now();t+=`\n                            <div class="generated-image">\n                                <img id="${r}" src="${i}" alt="${e}" />\n                                <p class="image-prompt">æç¤ºè¯ï¼š${e}</p>\n                                <p class="image-time">ç”Ÿæˆæ—¶é—´ï¼š${n.toFixed(2)}ç§’</p>\n                                <p class="upload-status" id="${r}-status" style="color: #888; font-size: 12px;">æ­£åœ¨ä¿å­˜åˆ°äº‘ç«¯...</p>\n                            </div>\n                        `,this.showNotification("å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼æ­£åœ¨ä¿å­˜åˆ°äº‘ç«¯...","success"),s={requireUpload:a&&this.currentUser,tempImageUrl:i,messageId:o,imageId:r,prompt:e}}else{if(!c.text)return void this.showNotification("å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼šæœªè¿”å›å›¾ç‰‡","error");t+=this.formatMessageText(c.text),this.showNotification("ç”Ÿæˆå®Œæˆ","success")}else{if(c.text&&(t+=this.formatMessageText(c.text)),c.image){t+=`\n                            <div class="generated-image">\n                                <img src="data:${c.mimeType||"image/png"};base64,${c.image}" alt="${e}" />\n                                <p class="image-prompt">æç¤ºè¯ï¼š${e}</p>\n                                <p class="image-time">ç”Ÿæˆæ—¶é—´ï¼š${c.response_time.toFixed(2)}ç§’</p>\n                            </div>\n                        `}if(!c.text&&!c.image)return void this.showNotification("å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼šæ²¡æœ‰è¿”å›å†…å®¹","error");c.text&&c.image?this.showNotification("æ–‡å­—å’Œå›¾ç‰‡ç”ŸæˆæˆåŠŸï¼","success"):c.text?this.showNotification("æ–‡å­—ç”ŸæˆæˆåŠŸï¼","success"):c.image&&this.showNotification("å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼","success")}this.addMessageToUI({role:"assistant",content:t,created_at:(new Date).toISOString()}),this.scrollToBottom(),s&&s.requireUpload&&setTimeout((()=>{this.uploadImageToOSS(s.tempImageUrl,s.messageId,s.imageId,s.prompt)}),100),setTimeout((()=>{this.isMobile?this.updateSessionListOnly():this.loadSessions()}),1e3)}else c.quota_exceeded?(this.showNotification(`âš ï¸ ${c.error}`,"warning",8e3),this.addMessageToUI({role:"assistant",content:`âš ï¸ **å›¾ç‰‡é…é¢å·²æ»¡**\n\n${c.error}\n\næ‚¨å½“å‰å·²ç”Ÿæˆ ${c.current} å¼ AIå›¾ç‰‡ï¼Œè¾¾åˆ°ä¸Šé™ ${c.limit} å¼ ã€‚\n\n**å¦‚ä½•é‡Šæ”¾é…é¢ï¼š**\n- åˆ é™¤åŒ…å«AIç”Ÿæˆå›¾ç‰‡çš„å¯¹è¯ä¼šè¯\n- åˆ é™¤åé…é¢å°†è‡ªåŠ¨æ¢å¤`,created_at:(new Date).toISOString()})):this.showNotification("å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼š"+c.error,"error")}catch(e){this.showNotification("å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼š"+e.message,"error"),this.removeThinkingMessage(n)}finally{this.isLoading=!1,this.updateSendButton(),this.disableUserInput(!1)}}async uploadImageToOSS(e,t,s,i){const n=document.getElementById(s+"-status"),o=document.getElementById(s);try{n&&(n.textContent="æ­£åœ¨ä¸‹è½½å›¾ç‰‡...");const s=await fetch(e);if(!s.ok)throw new Error("ä¸‹è½½å›¾ç‰‡å¤±è´¥");const i=await s.blob();n&&(n.textContent="æ­£åœ¨è·å–ä¸Šä¼ å‡­è¯...");const a=await this.apiCall("/s4/presign",{method:"POST",body:{filename:`kolors-${Date.now()}.png`,content_type:i.type||"image/png",category:"ai-images"}});if(!a.success)throw new Error(a.error||"è·å–ä¸Šä¼ å‡­è¯å¤±è´¥");n&&(n.textContent="æ­£åœ¨ä¸Šä¼ åˆ°äº‘ç«¯...");const c=new FormData;for(const[e,t]of Object.entries(a.fields))c.append(e,t);c.append("file",i);const r=await fetch(a.url,{method:"POST",body:c});if(!r.ok&&201!==r.status)throw new Error(`ä¸Šä¼ å¤±è´¥: ${r.status}`);const l=a.public_url_cdn||a.public_url_hosted||a.public_url;if(o&&(o.src=l),n&&(n.textContent="å·²ä¿å­˜åˆ°äº‘ç«¯ âœ“",n.style.color="#4CAF50"),t)try{(await this.apiCall("/chat/update-message-image",{method:"POST",body:{message_id:t,old_url:e,new_url:l}})).debug}catch(e){}}catch(e){n&&(n.textContent="äº‘ç«¯ä¿å­˜å¤±è´¥ï¼Œä½¿ç”¨ä¸´æ—¶é“¾æ¥",n.style.color="#ff9800")}}async uploadBase64ToOSS(e,t,s,i){const n=document.getElementById(s+"-status"),o=document.getElementById(s);try{n&&(n.textContent="æ­£åœ¨å¤„ç†å›¾ç‰‡...");const s=e.match(/^data:([^;]+);base64,(.+)$/);if(!s)throw new Error("æ— æ•ˆçš„ Base64 æ ¼å¼");const i=s[1],a=s[2],c=atob(a),r=new Array(c.length);for(let e=0;e<c.length;e++)r[e]=c.charCodeAt(e);const l=new Uint8Array(r),d=new Blob([l],{type:i});n&&(n.textContent="æ­£åœ¨è·å–ä¸Šä¼ å‡­è¯...");const h=i.split("/")[1]||"png",m=await this.apiCall("/s4/presign",{method:"POST",body:{filename:`banana-${Date.now()}.${h}`,content_type:i,category:"ai-images"}});if(!m.success)throw new Error(m.error||"è·å–ä¸Šä¼ å‡­è¯å¤±è´¥");n&&(n.textContent="æ­£åœ¨ä¸Šä¼ åˆ°äº‘ç«¯...");const u=new FormData;for(const[e,t]of Object.entries(m.fields))u.append(e,t);u.append("file",d);const g=await fetch(m.url,{method:"POST",body:u});if(!g.ok&&201!==g.status)throw new Error(`ä¸Šä¼ å¤±è´¥: ${g.status}`);const p=m.public_url_cdn||m.public_url_hosted||m.public_url;if(o&&(o.src=p),n&&(n.textContent="å·²ä¿å­˜åˆ°äº‘ç«¯ âœ“",n.style.color="#4CAF50"),t)try{await this.apiCall("/chat/update-message-image",{method:"POST",body:{message_id:t,old_url:e.substring(0,100),new_url:p}})}catch(e){}}catch(e){n&&(n.textContent="äº‘ç«¯ä¿å­˜å¤±è´¥",n.style.color="#ff9800")}}}const app=new WAWAAIApp;
